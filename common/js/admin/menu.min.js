$.enable_disable_move_btn=function(){$.each($("ul.list-group").find("li"),function(){0===$(this).prev("li").length?$(this).find(".btn_move_up").addClass("disabled"):$(this).find(".btn_move_up").removeClass("disabled"),0===$(this).next("li").length?$(this).find(".btn_move_down").addClass("disabled"):$(this).find(".btn_move_down").removeClass("disabled"),0===$(this).find(".subpanel-body").length?$(this).closest("ul").hasClass("subpanel-body")||$(this).find(".btn_indent").removeClass("hidden"):$(this).find(".btn_indent").addClass("hidden"),$(this).closest("ul").hasClass("subpanel-body")?$(this).find(".btn_outdent").removeClass("hidden"):$(this).find(".btn_outdent").addClass("hidden")})},$.fn.move_row_up=function(){$(this).click(function(){var e=$(this),t=(e.closest(".btn-group").find(".btn_move_down"),e.closest(".menu_row")),n=t.prev("li");0!==n.length&&(t.insertBefore(n),$.enable_disable_move_btn())})},$.fn.move_row_down=function(){$(this).click(function(){var e=$(this),t=(e.closest(".btn-group").find(".btn_move_down"),e.closest(".menu_row")),n=t.next("li");0!==n.length&&(t.insertAfter(n),$.enable_disable_move_btn())})},$.fn.indent_row_btn=function(){$(this).click(function(){var e=$(this),t=e.closest(".menu_row"),n=t.next("li");if(n.find(".list-group").length>0)n.find(".list-group ul").prepend(t);else{var a=$('<div class="list-group">'),i=$('<ul class="subpanel-body list-group">');i.append(t),a.append(i),n.append(a)}$.enable_disable_move_btn()})},$.fn.outdent_row_btn=function(){$(this).click(function(){var e=$(this),t=e.closest(".menu_row"),n=e.closest(".list-group").closest(".menu_row");0!==n.length&&(t.insertBefore(n),0===n.find(".list-group ul li").length&&n.find(".list-group").remove(),t.find(".list-group").length>0&&t.find(".list-group").remove(),$.enable_disable_move_btn())})},$.add_menu=function(){var e=!0,t={};if($.each($("#menu_management_stage .list-group-item"),function(n,a){return 0===$(a).find(".menu_name").html().length?(t=$(a),e=!1,!1):void 0}),e){var n=($.url().attr("host"),$('<li id="'+$.md5("new_node"+$.now())+'" class="list-group-item">')),a=$('<div class="title_row">'),i=$('<div class="move-handle"></div>'),s=$('<div class="move-handle"></div>'),l=$('<div class="menu_data">'),o=$('<h4 class="list-group-item-heading">'),c=$('<span class="fa fa-indent menu_icon">'),r=$('<span class="menu_name">'),d=$('<span class="menu_link">').text("javascript:void(0);"),u=$('<span class="fa fa-fw">').html("&rsaquo;"),p=$("<tt>"),_=$('<div class="btn-group pull-right">'),f=$("<button>").attr({"data-placement":"top","data-toggle":"tooltip",title:i18n[lang].messages.edit,onclick:"$(this).edit_menu();","class":"btn btn-default-white edit_menu_btn"}).html('<span class="fa fa-fw fa-edit"></span>'),m=$("<button>").attr({"data-placement":"top","data-toggle":"tooltip",title:i18n[lang].messages.hide,onclick:"$(this).hide_menu();","class":"btn btn-default-white"}).html('<span class="fa fa-fw fa-eye-slash"></span>'),h=$('<small class="">'),b=$("<p>").attr({"class":"list-group-item-text list-group-item-body clearfix menu_title"}).html("<br />");p.append(h).append(d),_.append(f).append(m),o.append(c).append(" ").append(r).append(u).append(p).append(_),l.append(o).append(b),a.append(i).append(l).append(s),n.append(a),$("#menu_management_stage > ul.list-group").prepend(n),f.edit_menu(i18n[lang].messages.new_menu_item)}else t.find(".edit_menu_btn").edit_menu(i18n[lang].messages.new_menu_item)},$.fn.hide_menu=function(){var e=$(this),t=e.closest(".list-group-item").first();t.find(".title_row h4").first().find("span").toggleClass("not-visible"),t.find(".title_row h4").first().find("tt").toggleClass("not-visible"),t.find(".title_row p").first().toggleClass("not-visible"),e.toggleClass("active")},$.fn.edit_menu=function(e){$.generate_available_icons=function(e){$.storage_exists("pgrdg_user_cache.local.available_icons")?"function"==typeof e&&e(storage.get("pgrdg_user_cache.local.available_icons")):$.ajax({url:"common/include/funcs/_ajax/available_icons.php",DataType:"json",crossDomain:!0,type:"GET",timeout:1e4,success:function(t){storage.set("pgrdg_user_cache.local.available_icons",t.icons),"function"==typeof e&&e(t.icons)}})},$.fn.generate_available_icons_preview=function(e){$.fn.set_icon=function(e){var t=$(this).closest(".icon_box"),n=$("input#menu_icon");n.val(e),t.find("a.selected").removeClass("selected"),$(this).addClass("selected")};var t=$('<ul class="list-inline">');$.generate_available_icons(function(n){for(var a=0;a<n.length;a++){var i=$("<li>"),s=n[a],l=$("<a>").attr({href:"javascript:void(0);",onclick:"$(this).set_icon('fa "+s+"');",id:s,title:$.ucfirst(s.replace("fa-","").replace("-o-","-").replace("-o","").replace(/\-/g," ")),"class":e.replace("fa ","")==s?"selected":""}),o=$("<span>").addClass("fa fa-fw "+s);l.append(o),i.append(l),t.append(i)}}),$(this).append(t)},$("#loader").show();var t=$(this),n=t.closest(".menu_data").first(),a=t.closest(".list-group-item").find(".title_row").first(),i=n.find(".menu_title:first").text()!==i18n[lang].messages.no_title?n.find(".menu_title:first").text():"",s=n.find(".menu_name:first").text(),l=$.trim(n.find(".menu_icon:first").attr("class").replace("menu_icon","")),o=$.local_link_to_str(n.find(".menu_link:first").text()),c=$('<form class="form-horizontal">'),r=$('<div class="form-group">'),d=$('<div class="form-group">'),u=$('<div class="form-group">'),p=$('<div class="icon_box_container">'),_=$('<div class="row icon_box_header">'),f=$('<div class="col-sm-6">'),m=$('<div class="input-group">'),h=$('<span class="input-group-addon">').html('<span class="fa fa-search"></span>'),b=$('<div class="icon_box">'),v=$('<label class="control-label col-sm-2" for="menu_name">').text(i18n[lang].interface.forms.label_menu_text),g=$('<label class="control-label col-sm-2" for="menu_title">').text(i18n[lang].interface.forms.label_menu_title),w=$('<label class="control-label col-sm-2" for="menu_link">').text(i18n[lang].interface.forms.label_menu_link),x=$('<label class="control-label col-sm-6 text-left" for="menu_icon">').text(i18n[lang].interface.forms.label_menu_icon),k=$('<div class="col-sm-6">'),y=$('<div class="col-sm-10">'),C=$('<div class="col-sm-10">'),j=($('<div class="col-sm-10">'),$('<div class="input-group">')),T=$('<span class="input-group-btn">'),L=$('<button class="btn btn-default-grey" title="'+i18n[lang].interface.btns.empty_link+"\" onclick=\"$('#menu_link').val('javascript:void(0);'); return false;\">").html('<span class="fa fa-code">'),S=$('<input type="text" id="icon_search" class="form-control pull-right" placeholder="Search icon..." />'),q=$('<input type="text" class="form-control" id="menu_name" name="menu_name" required value="'+s+'" tabindex="1" />'),B=$('<input type="text" class="form-control" id="menu_title" name="menu_title" required value="'+i+'" tabindex="2" />'),A=$('<input type="url" class="form-control" id="menu_link" name="menu_link" required disabled value="'+o.replace(/\_/g," ")+'" tabindex="3" />');$input_icon=$('<input type="hidden" id="menu_icon" name="menu_icon" value="'+l+'" tabindex="4" />'),k.append(q),r.append(v),r.append(k),y.append(B),d.append(g),d.append(y),j.append(A),j.append(T),T.append(L),C.append(j),u.append(w),u.append(C),_.append(x),m.append(S),m.append(h),f.append(m),_.append(f),p.append(_),p.append($input_icon),b.generate_available_icons_preview(l),p.append(b),c.html(""),c.append(r),c.append(d),c.append(u),c.append(p),a.addClass("selected"),apprise(c[0].outerHTML,{title:void 0!==e&&null!==e&&""!==e?e:i18n[lang].messages.edit_menu,form:!0,allowExit:!1,cancelBtnClass:"btn-default-white",okBtnClass:"btn-default",onShown:function(){$.ajax({url:"common/include/funcs/_ajax/get_all_pages.php",DataType:"json",crossDomain:!0,type:"GET",timeout:1e4,success:function(e){var t=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("title"),queryTokenizer:Bloodhound.tokenizers.whitespace,local:e});t.initialize(),$("#menu_link").attr("disabled",!1),$("#menu_link").typeahead({hint:!0,highlight:!0,minLength:2},{name:"pages",displayKey:"title",source:t.ttAdapter()}).bind("typeahead:selected, typeahead:cursorchanged",function(e,t){$(this).on("blur",function(){$(this).val(t.link.replace(/\_/g," ").replace(/\//g,""))})})}}),$("#icon_search").on("keyup",function(){$("#icon_search").closest(".input-group").find(".fa").switchClass("fa-times","fa-search"),$("#icon_search").closest(".input-group").removeClass("has-error");var e=this,t=($("#icon_search").closest(".input-group"),$(".icon_box")),n=t.find("ul.list-inline li");$(".search-sf").remove(),$.each(n,function(t,a){var i=$(a).find("a").attr("data-original-title").toLowerCase(),s=$(e).val().toLowerCase();""!==s&&(-1==i.indexOf(s)?n.eq(t).hide():($(".search-sf").remove(),n.eq(t).show()))}),0===n.children(":visible").length&&($("#icon_search").closest(".input-group").find(".fa").switchClass("fa-search","fa-times"),$("#icon_search").closest(".input-group").addClass("has-error"),0===$("h1.search-sf").length&&t.append('<h1 class="search-sf" unselectable="true">No entries found.</h1>'))}),$(".icon_box").scrollTo("#"+l.replace("fa ",""),800,{offset:function(){return{top:-70}}})},onSave:function(e){e!==!1&&$.each(e,function(e,t){switch(t.name){case"menu_icon":a.find("."+t.name).attr("class","fa "+t.value+" menu_icon");break;case"menu_link":console.info($.str_to_local_link(t.value)),a.find("."+t.name).html($.str_to_local_link(t.value));break;default:a.find("."+t.name).text(t.value)}})},onHidden:function(){a.removeClass("selected")}})},$.fn.remove_menu=function(e){var t=$(this),n=t.closest(".menu_row");n.find(".title_row").addClass("selected"),apprise(i18n[lang].messages.delete_menu.message,{title:i18n[lang].messages.delete_menu.title.replace("{X}",'"'+e+'"'),confirm:!0,allowExit:!0},function(e){e?n.find(".title_row").fadeOut(300,function(){t.closest(".menu_row").remove()}):n.find(".title_row").removeClass("selected")})},$.save_menu=function(){$.fn.get_row_data=function(){var e={},t=$(this),n=t.find(".menu_data:first"),a=$.trim(n.find(".menu_name").text()),i=a.replace(/\_/g," "),s=n.find(".menu_icon").hasClass("not-visible")?!1:!0,l=$.trim(n.find(".menu_title").text().replace(i18n[lang].messages.no_title,"").replace("not-visible","")),o=$.trim(n.find("span.menu_icon").attr("class").replace("fa ","").replace("menu_icon","").replace("not-visible","")),c=$.local_link_to_str(n.find(".menu_link").html());return e[i]={},e[i].content={icon:"fa "+o,text:a},e[i].attributes={href:c,title:l,"class":"btn btn-link"+(s?"":" hidden")},$.obj_len(t.find(".list-group"))>0&&(e[i].childs={},$.each(t.find(".list-group > .subpanel-body > .list-group-item"),function(t,n){$.each($(n).get_row_data(),function(t,n){e[i].childs[t]=n})})),e};var e={};e.menu={},e.menu.top={},$.each($("#menu_management_stage > .list-group > .list-group-item"),function(t,n){$.each($(n).get_row_data(),function(t,n){e.menu.top[t.replace(/\_/g," ")]=n})}),e.menu.map_toolbox={Show_hide_menu:{content:{icon:"ion-navicon",text:""},attributes:{onclick:"$.sh_menu()",href:"javascript:void(0);","class":"btn",id:"show_hide_menu_btn",title:"Showorhidemainmenu(ALT+M)"},divider:"dividernav_divider"},Show_hide_breadcrumb:{content:{icon:"fafa-history",text:""},attributes:{onclick:"$.sh_breadcrumb()",href:"javascript:void(0);","class":"btn",id:"show_hide_breadcrumb_btn",title:"Showorhidebreadcrumb(ALT+B)"}},Find_location:{content:{icon:"ion-search",text:""},attributes:{onclick:"$.sub_toolbox('find_location');",href:"javascript:void(0);","class":"btn",id:"find_location_btn",title:"Findalocation(ALT+F)"}},Change_map:{content:{icon:"ion-map",text:""},attributes:{onclick:"$.sub_toolbox('change_map');",href:"javascript:void(0);","class":"btn",id:"change_map_btn",title:"Changemaptype(ALT+T)"}},Selection:{content:{icon:"icon-vector-selection",text:""},attributes:{onclick:"$.sub_toolbox('tools');",href:"javascript:void(0);","class":"btn",id:"selection_btn",title:"Show/hideselectiontools"},divider:"divider"},Lock_view:{content:{icon:"fafa-lock",text:""},attributes:{onclick:"$.toggle_lock_view();",href:"javascript:void(0);","class":"btn",id:"lock_view_btn",title:"Lock/unlockthisview(ALT+L)"}},Help:{content:{icon:"ion-help",text:""},attributes:{href:"javascript:void(0);","class":"btn",id:"help_btn",title:"Help(F1)",onclick:"$.show_help();"}}},e.menu.tools={Draw_polygon:{content:{icon:"icon-vector-polygon",text:""},attributes:{onclick:"$.draw_polygon();",href:"javascript:void(0);","class":"btn",id:"draw_polygon_btn",title:"Selectcustomarea"}},Draw_rectangle:{content:{icon:"icon-vector-rectangle",text:""},attributes:{onclick:"$.draw_rectangle();",href:"javascript:void(0);","class":"btn",id:"draw_rectangle_btn",title:"Selectsquaredarea"}},Draw_circle:{content:{icon:"icon-vector-circle",text:""},attributes:{onclick:"$.draw_circle();",href:"javascript:void(0);","class":"btn",id:"draw_circle_btn",title:"Selectcirculararea"}}},e.menu.map_contextmenu={Get_point:{content:{icon:"fafa-crosshairs",text:"Getinformationsofthispoint"},attributes:{href:"javascript:void(0);","class":"btn",title:"Help",onclick:"$.get_click_info();"},divider:"divider"}},e.menu.map_knob_contextmenu={Point_info:{content:{icon:"fafa-info-circle",text:""},attributes:{href:"javascript:void(0);","class":"",title:"Getinformationsofthispoint",onclick:"$.get_click_info();"}}},$.require_password(function(){$.ask_cyphered_to_service({storage_group:"pgrdg_user_cache.local.menu",data:e,dataType:"text",type:"save_menu"},function(e){"ok"==e?($.log_activity({action:"Changed menu",icon:"fa-list-alt"}),$("#alert").removeClass("alert-danger").addClass("alert-success").html('<span class="fa fa-check fa-1_5x pull-left"></span> '+i18n[lang].messages.menu_saved).fadeIn(600,function(){$("#alert").delay(3e3).fadeOut(600)})):$("#alert").removeClass("alert-success").addClass("alert-danger").html('<span class="fa fa-3x fa-times pull-left"></span> '+i18n[lang].messages.menu_not_saved).fadeIn(600),$("#loader").hide()})})},$(document).ready(function(){$.enable_disable_move_btn(),$(".btn_move_up").move_row_up(),$(".btn_move_down").move_row_down(),$(".btn_indent").indent_row_btn(),$(".btn_outdent").outdent_row_btn(),$("button").tooltip({trigger:"hover click"})});