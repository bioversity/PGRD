$.require_password=function(e,t){"function"==$.type(e)&&(t=e);var a=$.extend({current_attempt:1,status:""},e),_=($.get_user_username($.get_current_user_data()),3);void 0===$.cookie("iv")||null===$.cookie("iv")?apprise(i18n[lang].messages.insert_password.message+a.status,{title:i18n[lang].messages.insert_password.title,icon:"fa-lock",titleClass:"text-warning",input:!0,input_type:"password"},function(e){if(e)if($.md5($.sha1(e))==$.cookie("m")){var s=new Date;s.setTime(s.getTime()+6e5),$.cookie("iv",$.md5($.now()),{expires:s}),"function"==$.type(t)&&t.call(this)}else if(a.current_attempt<_){a.current_attempt++;var r={current_attempt:a.current_attempt,status:"wrong_password"};$.require_password(r,t)}}):"function"==$.type(t)&&t.call(this)},$.add_storage_space_in_panel=function(e,t){$.get_localstorage_space=function(e){var t="";for(var a in window.localStorage)window.localStorage.hasOwnProperty(a)&&(t+=window.localStorage[e]);return t?3+Math.round(16*t.length/8192*100)/100+" Kb":"0 Kb"};var a=$.get_localstorage_space(t),_=parseInt($.get_localstorage_space(t)),s=100*_/1e3,r="progress-bar-success",n="txt-color-darken";s>33?(r="progress-bar-warning",n="text-warning"):s>66&&(r="progress-bar-danger",n="text-danger");var i=$("<li>"),l=$('<div class="padding-5">'),o=$('<p class="'+n+' font-sm no-margin">'),d=$('<div class="progress progress-micro no-margin">'),c=$('<div class="progress-bar '+r+'" style="width: '+s+'%">');o.html("<b>"+e+":</b><br /><small>"+a+"</small>"),d.append(c),l.append(o).append(d),i.append(l),$("#local_storage_space").append(i)},$.get_user=function(e,t,a){$.ask_user=function(e,t,a){$.ask_cyphered_to_service({storage_group:"pgrdg_user_cache.user_data.all",data:{user_id:null===e||void 0===e||""===e?$.get_manager_id():e,manager_id:$.get_manager_id()},type:"get_user",force_renew:!0},function(t){"function"==typeof a&&$.each(t,function(t,_){storage.set("pgrdg_user_cache.user_data.all."+$.get_user_id(_),_),e==$.get_manager_id()&&(storage.set("pgrdg_user_cache.user_data.current."+$.get_user_id(_),_),storage.set("pgrdg_user_cache.user_data.current.id",$.get_user_id(_))),a.call(this,_)})})},$("#loader").show(),(void 0===t||null===t||""===t)&&(t=!1),t?$.ask_user(e,!0,a):$.storage_exists("pgrdg_user_cache.user_data.all."+e)?a.call(this,storage.get("pgrdg_user_cache.user_data.all."+e)):$.storage_exists("pgrdg_user_cache.user_data.current")?$.ask_user(e,!1,a):($.cookie("l",null,{path:"/"}),document.location="./Signin")},$.get_managed_users=function(e,t){$.storage_exists("pgrdg_user_cache.user_data.managed."+e)?t.call(this,storage.get("pgrdg_user_cache.user_data.managed."+e)):$.ask_cyphered_to_service({storage_group:"pgrdg_user_cache.user_data.managed",data:{user_id:null===e||void 0===e||""===e?$.get_manager_id():e,manager_id:$.get_manager_id()},type:"get_managed_users"},function(e){if("function"==typeof t){var a={};$.each(e,function(e,t){$.storage_exists("pgrdg_user_cache.user_data.all."+$.get_user_id(t))&&storage.set("pgrdg_user_cache.user_data.all."+$.get_user_id(t),t),a[$.get_user_id(t)]=t}),t.call(this,a)}$("#loader").hide()})},$.update_config=function(e){"object"==$.type(e)&&$.obj_len(e)>0&&$.ask_cyphered_to_service({data:{new_config:e},dataType:"text",type:"save_config",force_renew:!0},function(){})},$.fn.getAttributes=function(){var e=this,t={};return e&&e.length&&$.each(e.get(0).attributes,function(a,_){_=_.nodeName||_.name,a=e.attr(_),void 0!==a&&a!==!1&&(t[_]=a)}),t},$.fn.check_input=function(e){$.fn.isWrong=function(){$(this).closest("div.line").addClass("has-error"),$(this).focus()},$.fn.isRight=function(){$(this).closest("div.line").removeClass("has-error")},$input=$(this),$input.prop("required")&&""===$.trim($input.val())?($input.isWrong(),"function"==jQuery.type(e)&&e.call(this,$input,!1)):($input.isRight(),"function"==jQuery.type(e)&&e.call(this,$input,!0))},$.get_current_user_data=function(){return storage.get("pgrdg_user_cache.user_data.current."+$.get_current_user_id())},$.get_user_data=function(e){$.storage_exists("pgrdg_user_cache.user_data.current."+e)&&$.each(storage.get("pgrdg_user_cache.user_data.current."+e),function(e,t){return"object"==$.type(t)?t:void 0})},$.get_user_id=function(e){return e[kTAG_IDENTIFIER][kAPI_PARAM_RESPONSE_FRMT_DISP]},$.get_current_user_id=function(){var e="",t=0;return $.storage_exists("pgrdg_user_cache.user_data.current.id")?e=storage.get("pgrdg_user_cache.user_data.current.id"):$.each(storage.get("pgrdg_user_cache.user_data.current"),function(a,_){0===t&&(e=$.get_user_id(_),storage.set("pgrdg_user_cache.user_data.current.id",e)),t++}),e},$.get_manager_id=function(){return $.get_current_user_id()},$.get_user_database=function(e){return e[kTAG_CONN_BASE][kAPI_PARAM_RESPONSE_FRMT_DISP]},$.get_user_authority=function(e){return e[kTAG_AUTHORITY][kAPI_PARAM_RESPONSE_FRMT_DISP]},$.get_user_full_name=function(e){return e[kTAG_NAME][kAPI_PARAM_RESPONSE_FRMT_DISP]},$.get_user_username=function(e){return e[kTAG_CONN_CODE][kAPI_PARAM_RESPONSE_FRMT_DISP]},$.get_user_name=function(e){return e[kTAG_ENTITY_FNAME][kAPI_PARAM_RESPONSE_FRMT_DISP]},$.get_user_last_name=function(e){return e[kTAG_ENTITY_LNAME][kAPI_PARAM_RESPONSE_FRMT_DISP]},$.get_user_pgp_fingerprint=function(e){return e[kTAG_ENTITY_PGP_FINGERPRINT][kAPI_PARAM_RESPONSE_FRMT_DISP]},$.fn.get_user_work_position=function(e,t){var a=$(this);sha=void 0===t?!0:t,$.get_authority(e[kTAG_ENTITY_AFFILIATION][kAPI_PARAM_RESPONSE_FRMT_VALUE][0][kTAG_UNIT_REF],function(t){var _=e[kTAG_ENTITY_TITLE][kAPI_PARAM_RESPONSE_FRMT_DISP];sha&&(_+=" at "+t),a.html(_)})},$.get_user_email=function(e){return e[kTAG_ENTITY_EMAIL][kAPI_PARAM_RESPONSE_FRMT_DISP][0][kAPI_PARAM_RESPONSE_FRMT_DISP]},$.get_current_user_img=function(){var e,t="./common/media/img/admin/",a={};return $.storage_exists("pgrdg_user_cache.user_data.current."+$.get_current_user_id()+"."+kTAG_ENTITY_ICON)?e=t+"user_images/"+storage.get("pgrdg_user_cache.user_data.current."+$.get_current_user_id()+"."+kTAG_ENTITY_ICON+"."+kAPI_PARAM_RESPONSE_FRMT_DISP):(e=t+"user_rand_images/"+$.rand_int(0,38)+".jpg",a[kAPI_PARAM_RESPONSE_FRMT_DISP]=e,storage.set("pgrdg_user_cache.user_data.current."+$.get_current_user_id()+"."+kTAG_ENTITY_ICON,a)),e},$.get_user_img_src=function(e){var t,a="./common/media/img/admin/",_={};return void 0!==e[kTAG_ENTITY_ICON]?t=a+"user_images/"+e[kTAG_ENTITY_ICON][kAPI_PARAM_RESPONSE_FRMT_DISP]:$.storage_exists("pgrdg_user_cache.user_data.current."+$.get_current_user_id()+"."+kTAG_ENTITY_ICON)?t=storage.get("pgrdg_user_cache.user_data.current."+$.get_current_user_id()+"."+kTAG_ENTITY_ICON+"."+kAPI_PARAM_RESPONSE_FRMT_DISP):(t=a+"user_rand_images/"+$.rand_int(0,38)+".jpg",_[kAPI_PARAM_RESPONSE_FRMT_DISP]=t,storage.set("pgrdg_user_cache.user_data.current."+$.get_current_user_id()+"."+kTAG_ENTITY_ICON,_)),t},$.get_user_roles=function(e){return e[kTAG_ROLES]},$.get_user_roles_list=function(e){var t=[];return $.each(e[kTAG_ROLES][kAPI_PARAM_RESPONSE_FRMT_DISP],function(e,a){t.push(a[kAPI_PARAM_RESPONSE_FRMT_DISP])}),t.join(", ")},$.get_managed_users_count=function(e){return parseInt(e[kTAG_MANAGED_COUNT][kAPI_PARAM_RESPONSE_FRMT_DISP])},$.get_invited_users_count=function(e){return void 0===e[kTAG_INVITES]?0:$.obj_len(e[kTAG_INVITES][kAPI_PARAM_RESPONSE_FRMT_DOCU])},$.load_profile=function(){var e=$.url().fsegment();if(e.length>0)if("Edit"===e[0])$.get_user(e[1],!1,function(){$("#personal_data").load_user_data_in_form(e[1]),$("#managed_scroller_title").length>0&&$("#managed_scroller_title").hide(),$("#managed_scroller").length>0&&$("#managed_scroller").hide(),$("#invited_box_title").length>0&&$("#invited_box_title").hide(),$("#data_box").length>0&&$("#data_box").hide()});else{var t=e[0].length>0?e[0]:e;$("#personal_data").load_user_data(t),$("#managed_scroller_title").length>0&&$("#managed_scroller_title").show(),$("#managed_scroller").length>0&&$("#managed_scroller").show(),$("#invited_box_title").length>0&&$("#invited_box_title").show(),$("#data_box").length>0&&$("#data_box").show()}else $("#personal_data").load_user_data()},$.fn.generate_manager_profile=function(e){var t=$(this),a=$('<div id="managers" class="top_content_label">'),_=$("<h1>").text(i18n[lang].messages.managed_by),s=$('<div class="manager">'),r=$("<h2>"),n=$("<a>").attr({href:"./Profile#"+$.get_user_id(e)}),i=$('<small class="help-block">').html(i18n[lang].messages.loading_profile),l=$("<img>").attr({src:$.get_user_img_src(e),alt:"me"});i.get_user_work_position(e,!1),n.append(l),n.append($.get_user_full_name(e)),n.append(i),$.get_user_id(e)==$.get_manager_id()&&n.attr("title",i18n[lang].interface.btns.back_to_your_profile),r.append(n),s.append(r),a.append(_),a.append(s),0===$("#managers").length&&t.prepend(a),console.log(e)},$.fn.generate_profile=function(e){$.fn.display_contact=function(e,t){var a=$(this);if(void 0!==t[e]){var _=$("<dt>"+$.ucfirst(t[e][kAPI_PARAM_RESPONSE_FRMT_NAME].replace("Entity ",""))+":</dt>"),s=$("<dd>"),r=$('<dl class="dl-horizontal">');$.each(t[e][kAPI_PARAM_RESPONSE_FRMT_DISP],function(e,t){var a=$("<dt>").text(t[kAPI_PARAM_RESPONSE_FRMT_NAME]),_=$("<dd>").html($.linkify(t[kAPI_PARAM_RESPONSE_FRMT_DISP]));r.append(a),r.append(_)}),s.append(r),a.append(_),a.append(s)}},$.fn.display_roles=function(e){var t=$(this),a=$('<dl class="dl-horizontal roles">');$.each(e[kTAG_ROLES][kAPI_PARAM_RESPONSE_FRMT_DISP],function(t,_){var s=$("<dt>"),r=$("<dd>"),n="";switch(e[kTAG_ROLES][kAPI_PARAM_RESPONSE_FRMT_VALUE][t]){case kTYPE_ROLE_LOGIN:n="fa fa-fw fa-sign-in";break;case kTYPE_ROLE_INVITE:n="fa fa-fw fa-certificate";break;case kTYPE_ROLE_UPLOAD:n="fa fa-fw fa-upload";break;case kTYPE_ROLE_EDIT:n="fa fa-fw fa-file-text-o";break;case kTYPE_ROLE_USERS:n="fa fa-fw fa-group"}s.html('<span class="'+n+' fa-3x text-success"></span>'),r.html(_[kAPI_PARAM_RESPONSE_FRMT_DISP]+'<i class="help-block">'+_[kAPI_PARAM_RESPONSE_FRMT_INFO]+"</i>"),a.append(s),a.append(r)}),t.append(a)};var t=$(this);$.storage_exists("pgrdg_user_cache.user_data.current")&&($.get_manager_id()!==$.get_user_id(e)?$.storage_exists("pgrdg_user_cache.user_data.current")&&$.each(storage.get("pgrdg_user_cache.user_data.current"),function(e,t){"object"==$.type(t)&&$("#contents").generate_manager_profile(t)}):$("#managers").remove());var a=$('<div class="row">'),_=$('<div class="col-xs-12 col-sm-3 col-md-4 col-lg-2 pull-left">'),s=$('<div class="col-xs-12 col-sm-9 col-md-8 col-lg-9 pull-right">'),r=$('<div class="col-xs-12 col-sm-12 col-md-12 col-lg-6">'),n=$('<div class="col-xs-12 col-sm-12 col-md-12 col-lg-6">'),l=$("<h1>"),o=($('<div class="col-xs-10 col-sm-7 col-sm-8 col-lg-8 pull-left">'),$('<div class="col-xs-2 col-sm-5 col-lg-4 pull-right">'),$('<span class="text-left">')),d=$("<h3>").text(i18n[lang].messages.contacts),c=$("<h3>").text(($.get_manager_id()!==$.get_user_id(e)?i18n[lang].messages.user_permissions:i18n[lang].messages.you_can)+":"),A=$('<div class="user_data">'),p=$('<div class="user_data">'),u=$("<a>").attr({"class":"btn btn-default-white pull-right",href:"./Profile#Edit/"+$.get_user_id(e),title:i18n[lang].interface.btns.edit_profile,"data-toggle":"tooltip","data-placement":"right"}).html('<span class="hidden-xs">'+i18n[lang].interface.btns.edit_profile+'&nbsp;</span><span class="fa fa-edit"></span>'),g=$("<h2>"),P=$("<span>"),E=$("<img>").attr({src:$.get_user_img_src(e),alt:"me"}),T=$('<div id="picture">'),f=$('<small class="help-block hidden-xs hidden-sm">');_.append(T);var k=[{label:"invited on",value:void 0!==e[kTAG_VERSION]?$.right_date(e[kTAG_VERSION][kAPI_PARAM_RESPONSE_FRMT_DISP]):" - "},{label:"Subscribed on",value:$.right_date(e[kTAG_RECORD_CREATED][kAPI_PARAM_RESPONSE_FRMT_DISP])}];for(i=0;2>i;i++){var R=$("<dl>"),m=$("<dt>"),I=$("<dd>");m.text(k[i].label),I.text(k[i].value),R.append(m),R.append(I),f.append(R)}_.append(f),P.append(E),T.append(P),a.append(_),o.text($.get_user_full_name(e)),void 0!==e[kTAG_ENTITY_TITLE]&&g.get_user_work_position(e,!0),l.append(o),l.append(u),s.append(l),s.append(g),r.append(d);var h=$("<dl>");h.display_contact(kTAG_ENTITY_PHONE,e),h.display_contact(kTAG_ENTITY_FAX,e),h.display_contact(kTAG_ENTITY_EMAIL,e),A.append(h),r.append(A),s.append(r),n.append(c),p.display_roles(e),n.append(p),s.append(n),s.append("<hr />"),a.append(s),t.addClass("container-fluid").html(a),t.load_active_users(e),-1!==$.inArray(kTYPE_ROLE_INVITE,e[kTAG_ROLES][kAPI_PARAM_RESPONSE_FRMT_VALUE])&&$("#managed_scroller").load_invited_users(e),$("#loader").hide()},$.fn.load_user_data=function(e){var t=$(this);"array"==$.type(e)&&(e=e[0]),void 0===e||null===e||""===e?$.storage_exists("pgrdg_user_cache.user_data.current")&&(window.location.hash=$.get_manager_id(),t.generate_profile(storage.get("pgrdg_user_cache.user_data.current."+$.get_manager_id()))):$.get_user(e,!1,function(e){t.generate_profile(e)})},$.fn.load_active_users=function(e){$.empty_scroller=function(e){var t=$("<p>"),a=$("<a>").attr({href:"./Invite#"+$.get_current_user_id()}).text(i18n[lang].interface.btns.invite_an_user);return-1!==$.inArray(kTYPE_ROLE_INVITE,e[kTAG_ROLES][kAPI_PARAM_RESPONSE_FRMT_VALUE])?(t.html('<span class="fa fa-times fa-2x"></span><br />'+i18n[lang].messages.no_active_users_yet),t.append("<br />"),t.append(a)):t.html('<span class="fa fa-times fa-2x"></span><br />'+i18n[lang].messages.no_created_users),t};var t=$(this),a=$(0===$("#managed_scroller").length?'<div id="managed_scroller">':"#managed_scroller"),_=$('<small class="text-info">').text($.get_managed_users_count(e)),s=$("<sup>").append(_),r=$(0===$("#managed_scroller_title").length?'<h2 id="managed_scroller_title">':"#managed_scroller_title"),n=$.get_user_id(e);r.html(e[kTAG_MANAGED_COUNT][kAPI_PARAM_RESPONSE_FRMT_NAME]+" "),r.append(s),0===$.get_managed_users_count(e)?(a.removeClass("has_data").html($.empty_scroller(e)),n!==$.get_manager_id()&&a.find("p").html('<span class="fa fa-times fa-2x"></span><br />'+i18n[lang].messages.no_created_users)):(a.html(""),a.addClass("has_data"),$.get_managed_users($.get_user_id(e),function(e){var t=$.url().fsegment(),_=$('<ul class="managed_picture list-inline">'),s=$("<li>");console.log(e),$.each(e,function(e,t){var a=$("<h1>"),r=$("<a>").attr({href:"./Profile#"+$.get_user_id(t)});$span=$("<span>"),$user_img=$("<img>").attr({src:$.get_user_img_src(t),alt:$.get_user_full_name(t)}),$span.text($.get_user_full_name(t)),r.append($user_img).append($span),a.append(r),s.attr("maged-user-id",$.get_user_id(t)).append(a),_.append(s)}),0===a.find("ul.managed_picture").length&&a.append(_),"Edit"!==t[0]&&a.fadeIn(300)})),a.insertAfter(t),r.insertBefore(a)},$.fn.load_invited_users=function(e){$.fn.load_invited_roles_icon=function(e){var t=$(this);$.each(e[kTAG_ROLES][kAPI_PARAM_RESPONSE_FRMT_VALUE],function(e,a){var _=$('<span class="fa fa-fw text-info">&nbsp;');switch(a){case kTYPE_ROLE_LOGIN:_.addClass("fa-sign-in");break;case kTYPE_ROLE_INVITE:_.addClass("fa-certificate");break;case kTYPE_ROLE_UPLOAD:_.addClass("fa-upload");break;case kTYPE_ROLE_EDIT:_.addClass("fa-edit");break;case kTYPE_ROLE_USERS:_.addClass("fa-group")}t.append(_)})};var t=$(this),a=$.get_user_id(e),_=$(0===$("#data_box").length?'<div id="data_box">':"#data_box"),s=$('<small class="text-info">').text($.get_invited_users_count(e)),r=$("<sup>").append(s),n=$(0===$("#invited_box_title").length?'<h2 id="invited_box_title">':"#invited_box_title"),i=$('<ul class="list-group">'),l=$(0===$("#invited_box").length?'<div id="invited_box" class="col-xs-12 col-sm-12 col-md-6 col-lg-6">':"#invited_box"),o=$("<a>").attr({href:"./Invite#"+a,"class":"btn btn-default pull-right"});o.html(a==$.get_manager_id()?i18n[lang].interface.btns.invite_an_user+' <span class="fa fa-plus"></span>':i18n[lang].interface.btns.invite_an_user_as.replace("{X}",$.get_user_name(e))+' <span class="fa fa-plus"></span>'),n.html(i18n[lang].messages.invited_users+" "),n.append(r),$.get_invited_users_count(e)>0?($.each(e[kTAG_INVITES][kAPI_PARAM_RESPONSE_FRMT_DOCU],function(e,t){var a=$.get_user_full_name(t[kAPI_PARAM_RESPONSE_FRMT_DOCU]),_=($.get_user_email(t[kAPI_PARAM_RESPONSE_FRMT_DOCU]),$('<li class="list-group-item">')),s=$('<div class="row">'),r=$('<div class="col-xs-7">'),n=$('<div class="col-xs-3">'),l=$('<div class="col-xs-2 text-right">'),o=$("<a>").attr({href:"mailto:"+a}),d=$("<p>"),c=$("<p>");o.text(a),d.html('<span class="fa fa-user-secret fa-fw text-muted"></span> '),d.append(o),r.html(d),c.attr("title",i18n[lang].messages.this_user_will_be_able_to+" "+$.get_user_roles_list(t[kAPI_PARAM_RESPONSE_FRMT_DOCU])),c.load_invited_roles_icon(t[kAPI_PARAM_RESPONSE_FRMT_DOCU]),c.tooltip(),n.html(c),l.html('<a class="btn btn-default-white" href="javascript:void(0);" onclick="$.delete_invitation(\''+$.get_user_pgp_fingerprint(t[kAPI_PARAM_RESPONSE_FRMT_DOCU])+'\')"><span class="fa fa-trash"></span></span>'),s.append(r).append(n).append(l),_.append(s),i.append(_)}),l.html(i),l.append(o),_.html(l)):(l.html('<p class="pull-left text-muted"><i>'+i18n[lang].messages.no_invited_users_yet+"</i></p>").append(o),_.append(l)),_.addClass("row").insertAfter(t),n.insertBefore(_)},$.cancel_user_editing=function(){apprise(i18n[lang].messages.undo_user_profile.message,{title:i18n[lang].messages.undo_user_profile.title,icon:"fa-warning",titleClass:"text-warning",confirm:!0},function(e){if(e){var t=$.url().fsegment();document.location="./Profile#"+t[1]}})},$.fn.roles_manager_box=function(e,t){if(void 0===e||null===e)if(void 0===t){var a=$.get_current_user_data();e=$.get_user_id(a),t=$.get_user_roles(a)}else e="";var _=$(this),s=$("<fieldset>"),r=$("<legend>").text(i18n[lang].messages.user_roles.roles),n=""===t[kAPI_PARAM_RESPONSE_FRMT_VALUE][0]?i18n[lang].messages.user_roles.no_roles:i18n[lang].messages.user_roles.effect_on_the_next_login,i=$('<div class="alert alert-warning">').html('<span class="fa fa-warning"></span> '+n),l=$("<ul>").addClass("list-group roles"),o=[];$.inArray(kTYPE_ROLE_LOGIN,t[kAPI_PARAM_RESPONSE_FRMT_VALUE])>-1&&o.push({text:i18n[lang].messages.user_roles.login.text,icon:"fa-lock",description:i18n[lang].messages.user_roles.login.description,id:"role-login",value:kTYPE_ROLE_LOGIN,"data-type":kTYPE_ROLE_LOGIN,checked:$.inArray(kTYPE_ROLE_LOGIN,t[kAPI_PARAM_RESPONSE_FRMT_VALUE])>-1?"checked":"",danger:!0,"data-content":i18n[lang].messages.user_roles.login.data_content}),$.inArray(kTYPE_ROLE_INVITE,t[kAPI_PARAM_RESPONSE_FRMT_VALUE])>-1&&o.push({text:i18n[lang].messages.user_roles.invite.text,icon:"fa-user-plus",description:i18n[lang].messages.user_roles.invite.description,id:"role-invite",value:kTYPE_ROLE_INVITE,"data-type":kTYPE_ROLE_INVITE,checked:$.inArray(kTYPE_ROLE_INVITE,t[kAPI_PARAM_RESPONSE_FRMT_VALUE])>-1?"checked":"",danger:!1}),$.inArray(kTYPE_ROLE_UPLOAD,t[kAPI_PARAM_RESPONSE_FRMT_VALUE])>-1&&o.push({text:i18n[lang].messages.user_roles.upload.text,icon:"fa-upload",description:i18n[lang].messages.user_roles.upload.description,id:"role-upload",value:kTYPE_ROLE_UPLOAD,"data-type":kTYPE_ROLE_UPLOAD,checked:$.inArray(kTYPE_ROLE_UPLOAD,t[kAPI_PARAM_RESPONSE_FRMT_VALUE])>-1?"checked":"",danger:!1}),$.inArray(kTYPE_ROLE_EDIT,t[kAPI_PARAM_RESPONSE_FRMT_VALUE])>-1&&o.push({text:i18n[lang].messages.user_roles.edit_contents.text,icon:"fa-file-text-o",description:i18n[lang].messages.user_roles.edit_contents.description,id:"role-edit",value:kTYPE_ROLE_EDIT,"data-type":kTYPE_ROLE_EDIT,checked:$.inArray(kTYPE_ROLE_EDIT,t[kAPI_PARAM_RESPONSE_FRMT_VALUE])>-1?"checked":"",danger:!1}),$.inArray(kTYPE_ROLE_USERS,t[kAPI_PARAM_RESPONSE_FRMT_VALUE])>-1&&o.push({text:i18n[lang].messages.user_roles.manage_users.text,icon:"fa-group",description:i18n[lang].messages.user_roles.manage_users.description,id:"manage-users",value:kTYPE_ROLE_USERS,checked:$.inArray(kTYPE_ROLE_USERS,t[kAPI_PARAM_RESPONSE_FRMT_VALUE])>-1?"checked":"",danger:!1}),$.each(o,function(t,a){var _=$('<li class="list-group-item">'),s=$('<div class="pull-right">'),r=$("<input>").attr({type:"checkbox","data-type":a.value,id:a.id,value:a.value}),n=$("<label>").attr("for",a.id).addClass("text-left"),i=$("<h3>"),o=$("<p>").addClass("list-group-item-text").text(a.description),d=$("<span>").addClass("fa fa-fw text-muted "+a.icon);i.append(d).append(a.text).addClass("list-group-item-heading"),n.append(i),n.append(o),void 0!==a.checked&&""!==a.checked&&"checked"==a.checked?(_.addClass("list-group-item-success"),r.attr("checked",a.checked)):r.attr("checked",!1),a.danger&&(r.attr({"data-off-color":"danger","data-content":a.title}),i.append(' <sup><small class="fa fa-exclamation-triangle text-warning" style="font-size: 12px;"></small></sup>'),_.popover({placement:"top",trigger:"hover",title:'<span class="text-warning"><span class="fa fa-exclamation-triangle"></span> Warning</span>',html:!0,content:a["data-content"],viewport:"#invite_user"})),_.append(n),s.append(r),_.append(s),a.value==kTYPE_ROLE_LOGIN?e!==$.get_manager_id()&&l.append(_):l.append(_)}),s.append(r),s.append(i).append(l),_.append(s)},$.activate_roles_manager_box=function(){$("[type='checkbox']").bootstrapSwitch({size:"small",labelText:"⋮",onText:"Yes",offText:"No"}).on("switchChange.bootstrapSwitch",function(e,t){if("role-login"==e.target.id){var a=$("#role-invite, #role-upload, #role-edit, #manage-users"),_=a.closest("li.list-group-item");t?($(this).closest("li.list-group-item").removeClass("list-group-item-danger"),_.removeClass("disabled"),$.each(_,function(){$(this).hasClass("list-group-item-not-success")&&$(this).switchClass("list-group-item-not-success","list-group-item-success")}),a.bootstrapSwitch("toggleIndeterminate",!1),a.bootstrapSwitch("toggleDisabled",!1)):($(this).closest("li.list-group-item").addClass("list-group-item-danger"),_.addClass("disabled"),$.each(_,function(){$(this).hasClass("list-group-item-success")&&$(this).switchClass("list-group-item-success","list-group-item-not-success")}),a.bootstrapSwitch("toggleIndeterminate",!0),a.bootstrapSwitch("toggleDisabled",!0))}else t?($(this).attr("checked",!0),$(this).closest("li.list-group-item").addClass("list-group-item-success")):($(this).attr("checked",!1),$(this).closest("li.list-group-item").removeClass("list-group-item-success"))})},$.fn.load_user_data_in_form=function(e){$.fn.add_typed=function(){var e=$(this).closest(".form-group"),t=e.find("div.line"),a=($.trim(e.attr("class").replace("form-group","")),0),_=$('<div class="line clearfix">'),s=($('<div class="form-group">'),$('<div class="col-sm-5">'),$('<div class="input-group">')),r=$('<div class="input-group-btn">'),n=($('<div class="col-sm-5 control-label text-muted text-left">'),$('<div class="col-sm-5 control-label text-muted text-left">')),i=$('<div class="col-sm-5 control-label text-muted text-left">'),l=($('<label class="col-sm-3 control-label">'),$('<label class="col-sm-3 control-label">')),o=($('<div class="col-sm-3 control-label text-muted">'),$("<input>")),d=$("<input>"),c=($("<a>").attr({href:"javascript:void(0);",onclick:"$(this).add_typed();","class":"btn btn-default-white"}),$("<a>").attr({href:"javascript:void(0);",onclick:"$(this).remove_typed();","class":"btn btn-default-white"}).html('<span class="fa fa-minus text-center">'));return n.attr("class","col-sm-4 col-xs-6"),i.attr("class","col-sm-4 col-xs-6 row"),$.each(e.find("input"),function(){return 0===$(this).val().length?(a++,$(this).focus(),!1):void 0}),0===a?(o.attr({type:"text","class":"form-control",required:"required","data-item":e.find("input:first").attr("data-item"),"data-tag":e.find("input:first").attr("data-tag"),"data-type":e.find("input:first").attr("data-type"),"data-struct":"k","data-count":t.length,id:e.find("input:first").attr("data-item"),name:e.find("input:first").attr("data-item"),placeholder:e.find("input:first").attr("placeholder"),value:""}),d.attr({type:"text","class":"form-control",required:"required","data-item":e.find("input:first").attr("data-item"),"data-tag":e.find("input:first").attr("data-tag"),"data-type":e.find("input:first").attr("data-type"),"data-struct":"v","data-count":t.length,id:e.find("input:first").attr("data-item"),name:e.find("input:first").attr("data-item"),placeholder:e.find("input:last").attr("placeholder"),value:""}),n.append(o),s.append(d),r.append(c),s.append(r),i.append(s),_.append(l).append(n).append(i),e.append(_),_.find("input[value='']:not(:checkbox,:button):visible:first").focus(),!1):void 0},$.fn.remove_typed=function(){var e=$(this).closest(".line");e.fadeOut(300,function(){e.remove()})},(void 0===e||null===e||""===e)&&(e=$.get_manager_id()),$.storage_exists("pgrdg_user_cache.user_data.current")&&($.get_manager_id()!==e?$.storage_exists("pgrdg_user_cache.user_data.current")&&$.each(storage.get("pgrdg_user_cache.user_data.current"),function(e,t){$("#contents").generate_manager_profile(t)}):$("#managers").remove());var t=$(this),a={},_=0;a[kTAG_RECORD_CREATED]={},a[kTAG_VERSION]={},a[kTAG_ENTITY_AFFILIATION]={},a[kTAG_ENTITY_FNAME]={},a[kTAG_ENTITY_FNAME]={},a[kTAG_ENTITY_LNAME]={},a[kTAG_NAME]={},a[kTAG_CONN_CODE]={},a[kTAG_ENTITY_EMAIL]={},a[kTAG_ENTITY_PHONE]={},a[kTAG_ENTITY_ICON]={},$.get_user(e,!1,function(s){$.each(s,function(){a[kTAG_VERSION][kAPI_PARAM_DATA_TYPE]="static",a[kTAG_VERSION][kAPI_RESULT_ENUM_LABEL]="Invited on",a[kTAG_VERSION][kAPI_PARAM_DATA]=s[kTAG_VERSION],a[kTAG_VERSION][kAPI_RESULT_ENUM_LABEL]="Subscribed on",a[kTAG_RECORD_CREATED][kAPI_PARAM_DATA_TYPE]="static",a[kTAG_RECORD_CREATED][kAPI_PARAM_DATA]=s[kTAG_RECORD_CREATED],a[kTAG_ENTITY_AFFILIATION][kAPI_PARAM_DATA_TYPE]="read",a[kTAG_ENTITY_AFFILIATION][kAPI_PARAM_DATA]=s[kTAG_ENTITY_AFFILIATION],a[kTAG_ENTITY_FNAME][kAPI_PARAM_DATA_TYPE]="edit",a[kTAG_ENTITY_FNAME][kAPI_PARAM_INPUT_TYPE]="text",a[kTAG_ENTITY_FNAME][kAPI_PARAM_DATA_KIND]="required",a[kTAG_ENTITY_FNAME][kAPI_PARAM_ID]=s[kTAG_ENTITY_FNAME][kAPI_PARAM_RESPONSE_FRMT_NAME].replace(/\s+/g,"_").toLowerCase(),a[kTAG_ENTITY_FNAME][kAPI_PARAM_DATA]=s[kTAG_ENTITY_FNAME],a[kTAG_ENTITY_LNAME][kAPI_PARAM_DATA_TYPE]="edit",a[kTAG_ENTITY_LNAME][kAPI_PARAM_INPUT_TYPE]="text",a[kTAG_ENTITY_LNAME][kAPI_PARAM_DATA_KIND]="required",a[kTAG_ENTITY_LNAME][kAPI_PARAM_ID]=s[kTAG_ENTITY_LNAME][kAPI_PARAM_RESPONSE_FRMT_NAME].replace(/\s+/g,"_").toLowerCase(),a[kTAG_ENTITY_LNAME][kAPI_PARAM_DATA]=s[kTAG_ENTITY_LNAME],a[kTAG_NAME][kAPI_RESULT_ENUM_LABEL]="Full name",a[kTAG_NAME][kAPI_PARAM_DATA_TYPE]="edit",a[kTAG_NAME][kAPI_PARAM_INPUT_TYPE]="text",a[kTAG_NAME][kAPI_PARAM_DATA_KIND]="required",a[kTAG_NAME][kAPI_PARAM_ID]=s[kTAG_NAME][kAPI_PARAM_RESPONSE_FRMT_NAME].replace(/\s+/g,"_").toLowerCase(),a[kTAG_NAME][kAPI_PARAM_DATA]=s[kTAG_NAME],a[kTAG_CONN_CODE][kAPI_PARAM_DATA_TYPE]="edit",a[kTAG_CONN_CODE][kAPI_PARAM_INPUT_TYPE]="text",a[kTAG_CONN_CODE][kAPI_PARAM_DATA_KIND]="required",a[kTAG_CONN_CODE][kAPI_RESULT_ENUM_LABEL]="Username",a[kTAG_CONN_CODE][kAPI_PARAM_ID]=s[kTAG_CONN_CODE][kAPI_PARAM_RESPONSE_FRMT_NAME].replace(/\s+/g,"_").toLowerCase(),a[kTAG_CONN_CODE][kAPI_PARAM_DATA]=s[kTAG_CONN_CODE],a[kTAG_ENTITY_EMAIL][kAPI_PARAM_DATA_TYPE]="read_edit",a[kTAG_ENTITY_EMAIL][kAPI_PARAM_INPUT_TYPE]="email",a[kTAG_ENTITY_EMAIL][kAPI_PARAM_ID]=s[kTAG_ENTITY_EMAIL][kAPI_PARAM_RESPONSE_FRMT_NAME].replace(/\s+/g,"_").toLowerCase(),a[kTAG_ENTITY_EMAIL][kAPI_PARAM_DATA]=s[kTAG_ENTITY_EMAIL],a[kTAG_ENTITY_PHONE][kAPI_PARAM_DATA_TYPE]="edit",a[kTAG_ENTITY_PHONE][kAPI_PARAM_INPUT_TYPE]="text",a[kTAG_ENTITY_PHONE][kAPI_PARAM_ID]=void 0!==s[kTAG_ENTITY_PHONE]?s[kTAG_ENTITY_PHONE][kAPI_PARAM_RESPONSE_FRMT_NAME].replace(/\s+/g,"_").toLowerCase():"",a[kTAG_ENTITY_PHONE][kAPI_PARAM_DATA]=s[kTAG_ENTITY_PHONE],a[kTAG_ENTITY_ICON][kAPI_PARAM_DATA_TYPE]="hide",a[kTAG_ENTITY_ICON][kAPI_PARAM_DATA]=s[kTAG_ENTITY_ICON]});var r=$('<div class="row">'),n=$('<div class="col-xs-12 col-sm-3 col-lg-2 pull-left" id="picture_container">'),i=$('<div class="col-xs-12 col-sm-8 col-lg-6 well form" id="user_data_container">'),l=$("<fieldset>"),o=$("<legend>").text("Personal data"),d=$('<a id="upload_btn" href="javascript:void(0);">'),c=$('<form action="" class="dropzone hidden" id="dropzone"></form>'),A=$("<img>").attr({src:$.get_user_img_src(s),alt:"me"}),p=$('<div id="picture">'),u=$('<small class="help-block">');d.append(A),p.append(d),p.append(c),n.append(p),l.append(o),t.html(""),$.each(a,function(t,o){_++;var d=$('<div class="line clearfix">'),c=$('<div class="form-group">'),A=$('<div class="col-sm-5">'),p=$('<div class="input-group">'),g=$('<div class="input-group-btn">'),P=$('<div class="col-sm-5 control-label text-muted text-left">'),E=$('<div class="col-sm-5 control-label text-muted text-left">'),T=$('<div class="col-sm-5 control-label text-muted text-left">'),f=$('<label class="col-sm-3 control-label">'),k=($('<label class="col-sm-3 control-label">'),""),R=$('<div class="col-sm-3 control-label text-muted">'),m=$("<input>"),I=$("<input>"),h=$("<a>").attr({href:"javascript:void(0);",onclick:"$(this).add_typed();","class":"btn btn-default-white"}),M=$("<a>").attr({href:"javascript:void(0);",onclick:"$.cancel_user_editing();","class":"btn btn-default-white pull-left"}).html('<span class="fa fa-angle-left"></span> '+i18n[lang].interface.btns.cancel),v=$("<a>").attr({href:"javascript:void(0);",onclick:"$.save_user_data('"+e+"');","class":"btn btn-default pull-right"}).html(i18n[lang].interface.btns.save+' <span class="fa fa-angle-right"></span>');r.prepend(n);var N="";switch(o[kAPI_PARAM_DATA_TYPE]){case"static":var S=$('<dl class="visible-sm visible-md visible-lg">'),O=$("<dt>"),b=$("<dd>");O.text(void 0!==o[kAPI_RESULT_ENUM_LABEL]?o[kAPI_RESULT_ENUM_LABEL]:$.ucfirst(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_NAME].replace("Record ",""))),b.text(void 0!==o[kAPI_PARAM_DATA]?$.right_date(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP]):""),S.append(O),S.append(b),u.append(S),n.append(u);break;case"read":if($.is_obj(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP])||$.is_array(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP])){k=void 0!==o[kAPI_RESULT_ENUM_LABEL]?o[kAPI_RESULT_ENUM_LABEL]:$.ucfirst(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_NAME].replace("Record ","")),R.text(k);var D=$('<ul class="list-unstyled">');$.each(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_VALUE],function(e,t){$.is_obj(t)||$.is_array(t)?kTAG_UNIT_REF in t&&(D.append('<li id="'+$.trim(t[kTAG_TYPE])+'"><i>Loading...</li>'),$.get_authority(t[kTAG_UNIT_REF],function(e){$("#"+$.trim(t[kTAG_TYPE])).html(e)})):D.html("<li><i>none</i></li>")}),E.html(D),d.addClass($.md5(k)),d.append(R),d.append(E),l.append(d)}else k=void 0!==o[kAPI_RESULT_ENUM_LABEL]?o[kAPI_RESULT_ENUM_LABEL]:$.ucfirst(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_NAME].replace("Record ","")),R.text(k),E.text($.right_date(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP])),d.addClass($.md5(k)),c.append(R),c.append(E);l.append(c),i.append(l),r.append(i);break;case"read_edit":$.is_obj(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP])||$.is_array(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP])?(k=void 0!==o[kAPI_RESULT_ENUM_LABEL]?o[kAPI_RESULT_ENUM_LABEL]:$.ucfirst(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_NAME]),f.attr("for",o[kAPI_PARAM_ID]),f.text(k),d.append(f),$.each(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP],function(e,a){$.each(a,function(){$.each(a,function(){N=a[kAPI_PARAM_RESPONSE_FRMT_DISP]})}),P.attr("class","col-sm-9 col-xs-12").append('<span class="help-block">'+a[kAPI_PARAM_RESPONSE_FRMT_NAME]+": "+$.linkify(N)+"</span>"),m.attr({type:"text","class":"form-control typed_key","data-item":o[kAPI_PARAM_ID],"data-tag":t,"data-type":o.data[kAPI_PARAM_DATA_TYPE],"data-struct":"k","data-count":0,id:o[kAPI_PARAM_ID]+"_k",name:o[kAPI_PARAM_ID]+"_k",placeholder:$.ucfirst(kAPI_RESULT_ENUM_LABEL),value:""}),I.attr({type:void 0!==o[kAPI_PARAM_INPUT_TYPE]?o[kAPI_PARAM_INPUT_TYPE]:"text","class":"form-control typed_value","data-item":o[kAPI_PARAM_ID],"data-tag":t,"data-type":o.data[kAPI_PARAM_DATA_TYPE],"data-struct":"v","data-count":0,id:o[kAPI_PARAM_ID]+"_v",name:o[kAPI_PARAM_ID]+"_v",placeholder:o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_NAME],value:""}),d.addClass($.md5(k)),E.attr("class","col-sm-4 col-xs-6 col-sm-offset-3").append(m),T.attr("class","col-sm-4 col-xs-6 row"),h.html('<span class="fa fa-plus text-center">'),g.append(h),p.append(I)
}),p.append(g),A.append(E),A.append(T),T.append(p),d.append(P).append(E).append(T),c.append(d)):(k=void 0!==o[kAPI_RESULT_ENUM_LABEL]?o[kAPI_RESULT_ENUM_LABEL]:$.ucfirst(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_NAME].replace("Record ","")),R.text(k),E.text($.right_date(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP])),m.attr({type:"hidden","class":"form-control","data-item":o[kAPI_PARAM_ID],"data-tag":t,"data-type":o.data[kAPI_PARAM_DATA_TYPE],"data-struct":"v","data-count":0,id:o[kAPI_PARAM_ID]+"_k",name:o[kAPI_PARAM_ID]+"_k",placeholder:o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_NAME],value:""}),d.addClass($.md5(k)),c.append(R),c.append(E)),c.addClass(o[kAPI_PARAM_DATA_TYPE]+"_item"),l.append(c),i.append(l),r.append(i);break;case"edit":k=void 0!==o[kAPI_RESULT_ENUM_LABEL]?o[kAPI_RESULT_ENUM_LABEL]:void 0!==o[kAPI_PARAM_DATA]?$.ucfirst(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_NAME].replace("Entity ","")):"",f.addClass("col-xs-12").attr("for",o[kAPI_PARAM_ID]),f.text(k),void 0!==o[kAPI_PARAM_DATA]&&($.is_obj(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP])||$.is_array(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP])?(d.append(f),$.each(o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP],function(e,a){($.is_obj(a)||$.is_array(a))&&$.each(a,function(e){m.attr({type:"text","class":"form-control","data-item":o[kAPI_PARAM_ID],"data-tag":t,"data-type":o.data[kAPI_PARAM_DATA_TYPE],"data-struct":"k","data-count":0,id:o[kAPI_PARAM_ID]+"_k",name:o[kAPI_PARAM_ID]+"_k",placeholder:$.ucfirst(kAPI_RESULT_ENUM_LABEL),value:a[kAPI_PARAM_RESPONSE_FRMT_NAME]}),I.attr({type:void 0!==o[kAPI_PARAM_INPUT_TYPE]?o[kAPI_PARAM_INPUT_TYPE]:"text","class":"form-control","data-item":o[kAPI_PARAM_ID],"data-tag":t,"data-type":o.data[kAPI_PARAM_DATA_TYPE],"data-struct":"v","data-count":0,id:o[kAPI_PARAM_ID]+"_v",name:o[kAPI_PARAM_ID]+"_v",placeholder:o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_NAME],value:a[e]}),E.attr("class","col-sm-4 col-xs-6").append(m),T.attr("class","col-sm-4 col-xs-6 row"),h.html('<span class="fa fa-plus text-center">'),g.append(h),p.append(I)})}),p.append(g),A.append(E),A.append(T),T.append(p),d.append(E).append(T),c.append(d)):(d.append(f),m.attr({type:void 0!==o[kAPI_PARAM_INPUT_TYPE]?o[kAPI_PARAM_INPUT_TYPE]:"text","class":"form-control",id:o[kAPI_PARAM_ID],name:o[kAPI_PARAM_ID],"data-tag":t,"data-type":o.data[kAPI_PARAM_DATA_TYPE],"data-struct":"k","data-count":0,placeholder:o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_NAME],value:o[kAPI_PARAM_DATA][kAPI_PARAM_RESPONSE_FRMT_DISP]}),"required"==o[kAPI_PARAM_DATA_KIND]&&m.attr("required","required"),A.attr("class","col-sm-5 col-xs-12").append(m),d.append(A))),d.addClass($.md5(k)),c.addClass(o[kAPI_PARAM_DATA_TYPE]+"_item"),"required"==o[kAPI_PARAM_DATA_KIND]&&c.addClass("required"),c.append(d),l.append(c),i.append(l),r.append(i)}_===$.obj_len(a)&&(E.attr("class","col-xs-12 col-sm-8 col-md-8 col-lg-6 col-xs-offest-3 col-sm-offset-3 col-lg-offset-2").append(M).append(v),d.append(E),c.addClass("btns-group"),i.append(l),i.roles_manager_box(e,s[kTAG_ROLES]),r.append(i),r.append(d))}),t.html(r),$.activate_roles_manager_box(),$("#loader").hide();var g;$("#upload_btn").on("click",function(){$.require_password(function(){$("#picture_container .dz-message").length>0&&Dropzone.forElement("#picture_container form").destroy(),$("#picture_container form").dropzone({previewTemplate:document.querySelector("#picture #upload_btn").innerHTML,autoDiscover:!1,sendingmultiple:!1,acceptedFiles:".jpg,.jpeg,.png",autoProcessQueue:!0,maxFilesize:2,clickable:!0,dictDefaultMessage:'<span class="fa fa-cloud-upload fa-5x text-muted"></span><br /><br />'+i18n[lang].messages.drop_file_here,init:function(){this.on("processing",function(t){var a=t.name.split(".").pop().toLowerCase();g=e+"."+a,this.options.url="/API/?upload_image="+g}),this.on("sending",function(e,t,a){a.append("user_id",$.get_current_user_id())}),$("#picture_container form").click()},addedfile:function(e){$("#picture").removeClass("error").tooltip("destroy"),$("#picture").addClass("loading"),e.previewElement=Dropzone.createElement(this.options.previewTemplate)},thumbnail:function(e,t){$("#picture #upload_btn img").attr("src",t),$("#left-panel .login-info a > img").attr("src",t)},success:function(){$.save_user_image(e,g,function(){$("#picture").removeClass("loading"),$.log_activity({action:"Changed personal picture",icon:"fa-picture-o"})})},error:function(e,t){$("#picture").addClass("error").attr("data-original-title",t).tooltip({placement:"right",trigger:"click"}).tooltip("show")}})})})})},$.save_user_image=function(e,t,a){var _={};_[kAPI_REQUEST_USER]=$.get_manager_id(),_[kAPI_PARAM_ID]=e,_[kAPI_PARAM_OBJECT]={},_[kAPI_PARAM_OBJECT][kTAG_ENTITY_ICON]=t,$.ask_cyphered_to_service({data:_,type:"save_user_image"},function(e){"function"==typeof a&&$.obj_len(e)>0&&"ok"==e[kAPI_STATUS_STATE]&&a.call(this)})},$.save_user_data=function(e){var t={},a={},_="",s=0;t[kTAG_ROLES]=[],$.each($(".well.form :input"),function(e,a){$(a).check_input(function(e,r){if(!r)return s++,!1;var n=e.getAttributes();if(_=n["data-tag"],""!==$.trim($(a).val()))switch(n["data-type"]){case kTYPE_TYPED_LIST:var i=[];$.each(e.closest("div.form-group").find("div.line"),function(e,a){var s={},r=$(a).find("input").serializeArray();t[_]=[],t[_][e]={},$.each(r,function(){s[kTAG_TYPE]=r[0].value,s[kTAG_TEXT]=r[1].value}),r.length>0&&(i[e]=s)}),t[_]=i;break;case kTYPE_ROLE_LOGIN:case kTYPE_ROLE_INVITE:case kTYPE_ROLE_UPLOAD:case kTYPE_ROLE_EDIT:case kTYPE_ROLE_USERS:e.is(":checked")&&t[kTAG_ROLES].push(n.value);break;default:t[_]=n.value}})}),0===t[kTAG_ROLES].length&&(t[kTAG_ROLES]=[""]),a[kAPI_PARAM_OBJECT]=t,0===s&&$.require_password(function(){$("#loader").show(),a[kAPI_REQUEST_USER]=$.get_manager_id(),a[kAPI_PARAM_ID]=e,$.ask_cyphered_to_service({storage_group:"pgrdg_user_cache.user_data.all."+e,data:a,type:"save_user_data"},function(t){$.obj_len(t)>0&&"ok"==t[kAPI_STATUS_STATE]?($.log_activity({action:"Updated user data",icon:"fa-tasks"}),$.get_user(e,!0,function(){$("#loader").hide(),apprise(i18n[lang].messages.data_saved.message,{title:i18n[lang].messages.data_saved.title,icon:"fa-check",titleClass:"text-success"},function(e){if(e){{$.url().fsegment()}window.location.href="./Profile"}})})):($("#loader").hide(),apprise(i18n[lang].messages.errors.theres_an_error.message,{title:i18n[lang].messages.errors.theres_an_error.title,icon:"fa-times",titleClass:"text-danger"}))})})},$.fn.remove_history_item=function(){var e=$(this),t=e.closest(".timeline_item"),a=t.attr("data-number");$.require_password(function(){t.slideUp(600,function(){$.unlog_activity(a),$.storage_exists("pgrdg_user_cache.user_activity")||$.load_history_page()})})},$.load_history_page=function(){var e=$('<div class="timeline">'),t=($('<div class="row">'),$("<h2>").html('<span class="fa fa-clock-o"></span> History')),a=$('<h1 unselectable="on">').html('<span class="fa fa-times"></span> '+i18n[lang].messages.no_history_yet);if($.storage_exists("pgrdg_user_cache.user_activity")){e.append(t);var _=storage.get("pgrdg_user_cache.user_activity"),s=_.length;_.reverse(),$.each(_,function(t,a){s--;var _=$('<div class="row">'),r=$('<div class="row timeline_item col-sm-9 col-lg-6" data-number="'+s+'">'),n=$('<div class="clearfix">'),i=$('<div class="col-xs-2 col-sm-1">'),l=$('<div class="col-xs-10 col-sm-11">');i.html('<span class="fa '+(a.icon.length>0?a.icon:"fa-dot-circle-o")+' fa-2x text-info"></span>');var o=$('<div class="well">'),d=$('<button type="button" class="close" onclick="$(this).remove_history_item()" data-original-title="'+i18n[lang].interface.btns.remove+'">').html('<span aria-hidden="true">&times;</span>').tooltip(),c=$("<h2>").text(a.action).append(d),A=$('<span data-original-title="'+a.date+'">').html('<span class="fa fa-clock-o"></span> '+$.timeago(a.date)).tooltip(),p=$('<small class="help-block">').append(A),u=$('<p class="lead">').html(a.body);o.append(c),o.append(p),o.append(u),l.append(o),r.append(i).append(l),_.append(r),e.append(_),e.append(n)}),$("#personal_data").html("").append(e)}else $("#personal_data").html("").append(a)},$.last_activity=function(e){e=void 0===e?!1:e;var t="";return $.storage_exists("pgrdg_user_cache.user_activity")?(l=storage.get("pgrdg_user_cache.user_activity"),l.reverse(),t=e?$.ucfirst(l[0].action)+"<br />on "+l[0].date:l[0].date):t=e?i18n[lang].messages.no_history_yet+" - "+$.now():$.now(),t},$.update_last_activity=function(){jQuery.timeago.settings.refreshMillis=0,$("span.timeago").attr("data-original-title",$.last_activity(!0)).text($.timeago($.last_activity())).tooltip({placement:"top",html:!0}),setTimeout(function(){},2e3)},$.set_breadcrumb=function(){$.fn.set_user_name=function(e){$(this).text($.get_user_full_name(e))};var e=$.url().fsegment(),t=$(0===$("#ribbon > ol.breadcrum").length?'<ol class="breadcrumb">':"#ribbon > ol.breadcrum"),a=$("<li>").addClass("home"),_=$("Profile"==current_path?'<a href="./Profile#'+$.get_manager_id()+'">':'<a href="./'+current_path+'">'),s=$("<li>");$("#ribbon > ol.breadcrum").remove(),_.text(current_path),a.html(_),t.html(a),$.each(e,function(a,_){40==_.length&&$.get_current_user_id()!==_&&($.storage_exists("pgrdg_user_cache.user_data.all."+_)?s.set_user_name(storage.get("pgrdg_user_cache.user_data.all."+_)):$.get_user(_,!1,function(e){s.set_user_name(e)}),void 0!==e[1]&&40==e[1].length&&(hash_title=e[1]),t.append(s))}),$("#ribbon").html(t)},$(document).ready(function(){switch($.set_breadcrumb(),$(window).on("hashchange",function(){$.set_breadcrumb()}).trigger("hashchange"),$.update_last_activity(),$("#user_mini_pict").attr("src",$.get_current_user_img()),current_path){case"Profile":{$("<button/>").addClass("btn btn-primary").prop("disabled",!0).text("Processing...").on("click",function(){var e=$(this),t=e.data();e.off("click").text("Abort").on("click",function(){e.remove(),t.abort()}),t.submit().always(function(){e.remove()})})}$("#loader").addClass("decrypt").show(),$.load_profile(),$(window).on("hashchange",function(){$.load_profile()}).trigger("hashchange"),$.add_storage_space_in_panel("Non-logged memory","pgrdg_cache"),$.add_storage_space_in_panel("User memory","pgrdg_user_cache");break;case"History":$.load_history_page();break;case"Invite":$("#loader").show(),$.generate_invite_form();break;case"Menu":;$("body").on("click",function(e){$(".edit_menu_btn").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||($(this).popover("hide"),$(this).popover("destroy"),$(this).removeClass("active"))})}).on("hidden.bs.popover",function(){var e=$(".popover").not(".in");e&&e.remove()}),$(".list-group-item").sortable({containment:"parent",axis:"y",handle:".move-handle"}).disableSelection();break;case"Pages":$.init_pages_management();break;case"Upload":$.init_upload()}});