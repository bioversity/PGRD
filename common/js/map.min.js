var l={},markerMap={},default_bbox=[],draws=[],drawing={},layers=[],baseLayers,control,current_layer,defaultLayer,draw_layer,lat,lon,map,markers,overlayLayers,user_layers,user_search_layers,user_draw_layers,zoom;$.get_map_config=function(e){var a={};$.storage_exists("pgrdg_cache.map_data.config")?"function"==typeof e&&e.call(this,storage.get("pgrdg_cache.map_data.config")):$.cryptAjax({url:"common/include/conf/_map.json",dataType:"json",success:function(t){"function"==typeof e&&(storage.set("pgrdg_cache.map_data.config",t),$.storage_exists("pgrdg_cache.map_data.index")||($.each(t.map.layers,function(e,t){"defaultLayer"!==e&&$.each(t,function(t,s){$.each(s,function(s,r){a[r.layer]={type:e,category:t,name:r.name}})})}),storage.set("pgrdg_cache.map_data.index",a)),e.call(this,t))}})},$.init_map=function(e){{var a=$.storage_exists("pgrdg_cache.map_data.layers.current.layer")?storage.get("pgrdg_cache.map_data.layers.current.layer"):{};$.storage_exists("pgrdg_cache.map_data.layers.current.layer.overlay")?storage.get("pgrdg_cache.map_data.layers.current.layer.overlay"):{}}return $.get_map_config(function(t){lon=t.map.default.coordinates.lon,lat=t.map.default.coordinates.lat,zoom=t.map.default.zoom.default_zoom,default_bbox=t.map.default.coordinates.bounding_box,map=new L.Map("pgrdg_map",{center:[lat,lon],zoom:zoom,minZoom:t.map.default.zoom.min_zoom,maxZoom:t.map.default.zoom.max_zoom,inertia:!0,zoomControl:!0,attributionControl:!0,fadeAnimation:!0,zoomAnimation:!0,markerZoomAnimation:!0}),user_layers=new L.LayerGroup,user_search_layers=new L.LayerGroup,user_draw_layers=new L.LayerGroup,draw_layer=new L.FeatureGroup([user_draw_layers]),user_layers.addTo(map),user_search_layers.setZIndex(1),user_search_layers.addTo(map),user_draw_layers.setZIndex(2),user_draw_layers.addTo(map),L.control.scale().addTo(map),selected_layer=$.obj_len(a)>0&&a.layer!==t.map.layers.defaultLayer.layer?a:t.map.layers.defaultLayer,defaultLayer=L.tileLayer.provider(selected_layer.layer),defaultLayer.addTo(map),baseLayers=t.map.layers.baseLayers,overlayLayers=t.map.layers.overlayLayers,$("#change_map").html('<ul class="list-unstyled">');var s=0,r=0;$.each(baseLayers,function(e,a){r++,$.each(a,function(e,a){$("#change_map ul").append(a.layer==selected_layer.layer?'<li class="selected" onclick="$.change_map_layer(\''+$.utf8_to_b64(JSON.stringify(a))+'\')"><a title="Change layer" href="javascript: void(0);" class="btn change_map_btn '+a.layer.replace(".","_")+'"><span class="fa fa-check-circle"></span>&nbsp;&nbsp;'+a.name+"</a>":"<li onclick=\"$.change_map_layer('"+$.utf8_to_b64(JSON.stringify(a))+'\')"><a title="Change layer" href="javascript: void(0);" class="btn change_map_btn '+a.layer.replace(".","_")+'"><span class="fa fa-circle-o"></span>&nbsp;&nbsp;'+a.name+"</a>"),layers.push(a.layer)}),r<=$.obj_len(baseLayers)&&$("#change_map ul").append('<li class="divider"></li>')}),$.each(t.map.layers.overlayLayers,function(e,a){s++,$.each(a,function(e,a){void 0!==a.layer&&null!==a.layer&&""!==a.layer&&($.storage_exists("pgrdg_cache.map_data.layers.current.overlay."+a.layer.replace(/\./g,"~"))?($("#change_map ul").append('<li class="keep_open selected" onclick="$.change_map_layer(\''+$.utf8_to_b64(JSON.stringify(a))+'\')"><a title="Add/remove overlay" href="javascript: void(0);" class="btn change_map_btn '+a.layer.replace(".","_")+'"><span class="fa fa-check-square"></span>&nbsp;&nbsp;'+a.name+"</a>"),$.show_layer($.utf8_to_b64(JSON.stringify(a)))):$("#change_map ul").append('<li class="keep_open" onclick="$.change_map_layer(\''+$.utf8_to_b64(JSON.stringify(a))+'\')"><a title="Add/remove overlay" href="javascript: void(0);" class="btn change_map_btn '+a.layer.replace(".","_")+'"><span class="fa fa-square-o"></span>&nbsp;&nbsp;'+a.name+"</a>"),layers.push(a.layer))}),s<$.obj_len(t.map.layers.overlayLayers)&&$("#change_map ul").append('<li class="divider keep_open"></li>')}),current_layer=selected_layer.layer,l[selected_layer.name]=defaultLayer,storage.set("pgrdg_cache.map_data.layers.current.layer",selected_layer);new L.Control.Draw({position:"topleft",draw:{polyline:!1,polygon:{allowIntersection:!1,drawError:{color:"#b00b00",timeout:1e3},shapeOptions:{color:"#ff0043",weight:2},lineJoin:"miter",showArea:!0,metric:!0},rect:{shapeOptions:{color:"#ff0043",weight:2}},circle:{shapeOptions:{color:"#ff0043",weight:2}},marker:!1},edit:{featureGroup:draw_layer,edit:!1,remove:!1,selectedPathOptions:{maintainColor:!1,opacity:.3}}});map.on("draw:drawstart",function(){$.show_guides()}),map.on("draw:created",function(e){$.get_drawned_bounds=function(e){var a={},t=[],s=[];return"circle"!==e.layerType?($.each(e.layer._latlngs,function(e,a){s[e]=[a.lng,a.lat]}),s.push([e.layer._latlngs[0].lng,e.layer._latlngs[0].lat]),t.push(s),a.type="Polygon",a.coordinates=t):(t=[e.layer._latlng.lng,e.layer._latlng.lat],a.type="Circle",a.coordinates=t,a.radius=Math.ceil(e.layer._mRadius)),a},$.execute=function(t){var s="",r="";"circle"==t.layerType?(s="km<sup>2</sup>",r=a._mRadius/1e3):(s="km<sup>2</sup>",r=L.GeometryUtil.geodesicArea(t.layer.getLatLngs())),$.sub_toolbox("tools"),$("#tools li.selected").removeClass("selected"),apprise(i18n[lang].messages.map.selected_area.replace("{X}",t.layerType).replace("{Y}",$.highlight(r.toFixed(3))).replace("{Z}",s),{title:i18n[lang].interface.map_selection,icon:"icon-vector-selection",titleClass:"text-info",showHeader:!0,"double":!0,cancelBtnClass:"btn-default-grey",okBtnClass:"btn-default",textCancel:'<span class="fa fa-trash"></span> '+i18n[lang].interface.btns.remove_selection,textOk:i18n[lang].interface.btns.search_in_shape+' <span class="fa fa-crop"></span>'},function(s){var r={};if(s===!0){var o={},n={};if($.storage_exists("pgrdg_cache.search.criteria")&&(r=$.get_storage_selected_forms()),$.storage_exists("pgrdg_cache.search.criteria.select_map_area"))o=storage.get("pgrdg_cache.search.criteria.select_map_area");else{o=$.get_drawned_bounds(t),storage.set("pgrdg_cache.search.criteria.select_map_area",o);var l=e.layer.getBounds(),i=l.getCenter();$.find_location({lon:i.lng,lat:i.lat,addressdetails:1,zoom:0,error:function(){alert("An error occurred while communicating with the OpenLS service. Please try again.")},success:function(e){datap=$.parseJSON(e),storage.set("pgrdg_cache.search.criteria.select_map_area.zone",{name:datap.display_name,ccode:datap.address.country_code})}})}n.storage_group="pgrdg_cache.summary",n[kAPI_REQUEST_OPERATION]=kAPI_OP_MATCH_UNITS,n.parameters={},n.parameters[kAPI_REQUEST_LANGUAGE]=lang,n.parameters[kAPI_REQUEST_PARAMETERS]={},n.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_LOG_REQUEST]=!0,n.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_CRITERIA]=r,n.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_CRITERIA][kAPI_SHAPE_TAG]={},n.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_CRITERIA][kAPI_SHAPE_TAG][kAPI_PARAM_INPUT_TYPE]=kAPI_PARAM_INPUT_SHAPE,n.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_CRITERIA][kAPI_SHAPE_TAG][kAPI_PARAM_SHAPE]=o,$.storage_exists("pgrdg_cache.search.criteria.fulltext")&&(n.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_CRITERIA][kAPI_PARAM_FULL_TEXT_OFFSET]={},n.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_CRITERIA][kAPI_PARAM_FULL_TEXT_OFFSET][kAPI_PARAM_INPUT_TYPE]=kAPI_PARAM_INPUT_TEXT,n.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_CRITERIA][kAPI_PARAM_FULL_TEXT_OFFSET][kAPI_PARAM_PATTERN]=storage.get("pgrdg_cache.search.criteria.fulltext")),n.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_GROUP]=[],n.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_SHAPE_OFFSET]=kTAG_GEO_SHAPE_DISP,$.ask_to_service(n,function(e){$.obj_len(e[kAPI_RESPONSE_RESULTS])>0||e[kAPI_RESPONSE_RESULTS].length>0?$.activate_panel("summary",{res:e},function(){$.restore_stage(),user_search_layers.clearLayers(),draws=[]}):apprise(i18n[lang].messages.map.no_data_found.message,{title:i18n[lang].messages.map.no_data_found.title,icon:"warning","class":"drawing"})})}else"perhaps"==s?a.editing.enable():(user_search_layers.clearLayers(),draws=[])})},$.remove_selection=function(e){return $("#apprise").is(":hidden")?($("#apprise.drawing").is(":hidden")&&$("#apprise.drawing").on("hidden.bs.modal",function(){$(".drawing").remove()}),$("#apprise.drawing").modal("hide").on("hidden.bs.modal",function(){$("#apprise").remove()}),e.preventDefault(),apprise(i18n[lang].messages.map.are_you_sure_to_remove.message,{title:i18n[lang].messages.map.are_you_sure_to_remove.title,icon:"warning","class":"drawing",confirm:!0},function(e){e&&(user_search_layers.clearLayers(),draws=[])}),!1):void 0},$.proceed=function(e){user_search_layers.clearLayers(),user_search_layers.addLayer(a),draws=[],draws.push(a),a.editing.enable(),$.execute(e),a.on("mouseover",function(){$("#pgrdg_map").css("cursor","pointer")}),a.on("mouseout",function(){$("#pgrdg_map").css("cursor","grab")}),a.on("click",function(){a.editing.enable()}),a.on("dblclick",function(){$.execute(e)}),$(document).bind("keydown","del",function(e){$.remove_selection(e)}),$("#pgrdg_map").on("click",function(){a.editing.disable()})};var a=(e.layerType,e.layer);0===draws.length?$.proceed(e):apprise(i18n[lang].messages.map.only_one_shape.message,{title:i18n[lang].messages.map.only_one_shape.title,confirm:!0},function(a){a&&$.proceed(e)}),$.hide_guides()}),drawing.polygon=new L.Draw.Polygon(map),drawing.rectangle=new L.Draw.Rectangle(map),drawing.circle=new L.Draw.Circle(map),map.invalidateSize(),map.setMaxBounds([[-85,-200],[85,200]]),$(".leaflet-control-attribution.leaflet-control").html('<div class="attribution">'+$(".leaflet-control-attribution.leaflet-control").html()+'</div><a class="info" href="javascript: void(0);" onclick="$(\'.leaflet-control-attribution.leaflet-control div.attribution\').toggle_layer_description();"><span class="fa fa-info-circle"></span></a>'),map.on("zoomend",function(e){var a=$.get_current_layer_options(),t=storage.get("pgrdg_cache.map_data.layers.current.layer"),s=void 0!==t.min_zoom?t.min_zoom:a.minZoom,r=void 0!==t.max_zoom?t.max_zoom:parseInt(a.maxZoom-4);e.target.options.minZoom=s,e.target.options.maxZoom=r}),e&&e(map)}),$("#pgrdg_map").hasClass("locked")?$.contextMenu(!1):$("#pgrdg_map").on("mousedown touchstart",function(){}).on("mouseup touchend",function(){$("#pgrdg_map").unbind("mousemove"),$(this).removeClass("grabbing")}),$("#pgrdg_map.locked canvas").on("dragstart touchmove",function(e){return e.preventDefault(),!1}),map},$.draw_polygon=function(){drawing.polygon.enable(),$("#draw_polygon_btn").closest("li").addClass("selected")},$.draw_rectangle=function(){drawing.rectangle.enable(),$("#draw_rectangle_btn").closest("li").addClass("selected")},$.draw_circle=function(){drawing.circle.enable(),$("#draw_circle_btn").closest("li").addClass("selected")},$.reset_map=function(){$("#pgrdg_map").remove(),$('<div id="pgrdg_map" style="display: none;">').insertAfter("#map")},$.get_current_bbox=function(){return map.getBounds()},$.get_current_bbox_pgrdg=function(){return[[default_bbox[0],default_bbox[3]],[default_bbox[2],default_bbox[3]],[default_bbox[2],default_bbox[1]],[default_bbox[0],default_bbox[1]],[default_bbox[0],default_bbox[3]]]},$.set_center=function(e,a,t){void 0===t&&(t=0),map.panTo(L.latLng(parseFloat(a),parseFloat(e)),{animate:!1}),0!==t&&$.set_zoom(parseFloat(t))},$.get_center_bbox=function(e){var a=e[0],t=e[1],s=e[2],r=e[3],o=new L.LatLng(a,s),n=new L.LatLng(t,r);return[o,n]},$.set_center_bbox=function(e){center=$.get_center_bbox(e),bounds=new L.LatLngBounds(center[0],center[1]),map.fitBounds(bounds,{maxZoom:9})},$.center_map_on=function(e){if(!$("#pgrdg_map").hasClass("locked")){var a={};switch(e){case"World":a.lon=0,a.lat=35,a.zoom=1;break;case"Africa":a.lon=18,a.lat=-2,a.zoom=4;break;case"Antarctica":a.lon=-10,a.lat=75,a.zoom=3;break;case"Asia":a.lon=90,a.lat=50,a.zoom=4;break;case"Europe":a.lon=12,a.lat=55,a.zoom=4;break;case"North America":a.lon=-98,a.lat=48,a.zoom=4;break;case"South America":a.lon=-58,a.lat=-28,a.zoom=4;break;case"Oceania":a.lon=130,a.lat=-15,a.zoom=4;break;case"Your position":navigator.geolocation.getCurrentPosition(function(e){return $.find_location({lon:e.coords.longitude,lat:e.coords.latitude,addressdetails:0,success:function(a){datap=$.parseJSON(a),$.set_center(e.coords.longitude,e.coords.latitude,13),$("#selected_zone").text(datap.display_name).fadeIn(300)}}),!1},function(){return $("#selected_zone").html("<i>Unable to find position</i>").fadeIn(300),!1})}"Your position"!=e&&($.set_center(a.lon,a.lat,a.zoom),$("#selected_zone").text(e).fadeIn(300))}},$.get_current_zoom=function(){return map.getZoom()},$.set_zoom=function(e){return map.setZoom(e)},$.increase_zoom=function(){$.set_zoom($.get_current_zoom()+1)},$.decrease_zoom=function(){$.set_zoom($.get_current_zoom()-1)},$.get_generated_layers=function(e){var a="",t="",s=!1;$.storage_exists("pgrdg_cache.map_data.user_layers")?($.storage_exists("pgrdg_cache.map_data.user_layers.results")&&($.each(storage.get("pgrdg_cache.map_data.user_layers.results"),function(a,s){var r=i18n[lang].interface.search;console.log("Not working... you must generate an MD5(CRITERIA + DOMAIN)... See form.js on line 365"),console.warn(s),t=$.md5(s[kAPI_PARAM_CRITERIA]+s[kAPI_PARAM_DOMAIN]),void 0!==s[kAPI_PARAM_CRITERIA].fulltext&&""!==s[kAPI_PARAM_CRITERIA].fulltext&&(r+=': "'+s[kAPI_PARAM_CRITERIA].fulltext.replace(/"/g,"")+'"'),void 0!==s[kAPI_PARAM_CRITERIA].node&&$.obj_len(s[kAPI_PARAM_CRITERIA].node)>0&&$.each(s[kAPI_PARAM_CRITERIA].node,function(e,a){r+=void 0===a.is_patch||a.is_patch!==!0?" in "+a.name:" "+a.name.toLowerCase()+"s"});var o=$("<li>"),n=$("<a>"),l=$("<a>"),i=$("<span>"),c=$("<span>");o.attr("id",t).addClass("keep_open"),n.addClass("btn pull-left").attr({href:"javascript: void(0);",onclick:"$(this).toggle_layer_btn('"+t+"');",title:i18n[lang].messages.search.switch_layer}),l.addClass("btn pull-right").attr({href:"javascript: void(0);",onclick:"$.remove_selected_search('"+t+"', 'map_data.user_layers.results', 'true');",title:i18n[lang].messages.search.remove_search}),i.addClass("fa "+(e==t?"fa-check-square":"fa-square-o")),c.addClass("fa fa-trash"),n.html(i),n.append(" "+r),l.html(c),o.html(n),o.append(l),$.each($("#user_layers li"),function(){$(this).find("a.pull-left span").removeClass("fa-check-square").addClass("fa-square-o")}),e==t&&$("li#"+t).find("a.pull-left span").removeClass("fa-square-o").addClass("fa-check-square"),0===$("li#"+t).length&&$("#selected_layer").append(o),console.log(t,$("li#"+t).length,e)}),s=!0),$.storage_exists("pgrdg_cache.map_data.user_layers.searches")&&($.each(storage.get("pgrdg_cache.map_data.user_layers.searches"),function(t,s){var r=i18n[lang].interface.search;void 0!==s.input&&""!==s.input&&(r+=' in map: "'+s.input+'"'),a=e==$.md5(s.input)?"fa-check-circle":"fa-circle-o",0===$("li#"+$.md5(s.input)).length&&$("#selected_layer").append('<li id="'+$.md5(s.input)+'" class="keep_open"><a class="btn pull-left" href="javascript: void(0);" onclick="$(this).search_location(\''+s.input+'\');" title="'+i18n[lang].messages.search.switch_layer+'"><span class="fa '+a+'"></span> '+r+'</a><a href="javascript: void(0);" onclick="$.remove_selected_search(\''+$.md5(s.input)+'\', \'map_data.user_layers.searches\');" class="btn pull-right" title="'+i18n[lang].messages.search.remove_search+'"><span class="fa fa-trash"></span></a></li>')}),s=!0)):s=!1,s?$("#user_level_btn").show():$("#user_level_btn").hide()},$.get_level_data=function(e){return void 0!==e.options?e.options:void 0},$.get_current_layer_options=function(){var e={};return $.each(l,function(a,t){e=t.options}),e},$.current_layer=function(){return current_layer},$.get_layer_index=function(e){var a=storage.get("pgrdg_cache.map_data.index");return a[e]},$.show_layer=function(e){var a=$.parseJSON($.b64_to_utf8(e)),t=a.name,s=a.layer,r=$.get_layer_index(s),o={};"baseLayers"!==r.type&&$.storage_exists("pgrdg_cache.map_data.layers.current.overlay")&&(o=storage.get("pgrdg_cache.map_data.layers.current.overlay")),e=a.layer,l[t]=L.tileLayer.provider(a.layer);var n=$.get_current_layer_options(),i=void 0!==a.min_zoom?a.min_zoom:n.minZoom,c=void 0!==a.max_zoom?a.max_zoom:parseInt(n.maxZoom-4);map.options.maxZoom=i,map.options.maxZoom=c,$.get_current_zoom()>c?(map.invalidateSize(),setTimeout(function(){map.setZoom(c)},0)):setTimeout(function(){map.setZoom($.get_current_zoom())},0),$.hide_all_layers(t),map.addLayer(l[t]),l[t].setZIndex(a.zindex),"baseLayers"==r.type?storage.set("pgrdg_cache.map_data.layers.current.layer",a):(o[s.replace(/\./g,"~")]=a,storage.set("pgrdg_cache.map_data.layers.current.overlay",o)),$(".leaflet-control-attribution.leaflet-control").html('<div class="attribution">'+$(".leaflet-control-attribution.leaflet-control").html()+'</div><a class="info" href="javascript: void(0);" onclick="$(\'.leaflet-control-attribution.leaflet-control div.attribution\').toggle_layer_description();"><span class="fa fa-info-circle"></span></a>')},$.hide_layer=function(e){map.removeLayer(l[e])},$.hide_all_layers=function(e){$.each(l,function(a,t){if(a!==e.name&&1===e.zindex){var s=$.get_level_data(t);void 0!==s&&1===s.zIndex&&($.hide_layer(a),delete l[a])}})},$.change_map_layer=function(e){var a=$.parseJSON($.b64_to_utf8(e)),t=storage.get("pgrdg_cache.map_data.layers.current.layer.layer");$this=$("#change_map a."+a.layer.replace(".","_")).find("span"),a.layer!==$.current_layer()?($this.hasClass("fa-circle-o")||$this.hasClass("fa-check-circle")?($("#change_map li").find("span.fa-check-circle").closest("li").removeClass("selected").find("span").removeClass("fa-check-circle").addClass("fa-circle-o"),$("#change_map a."+a.layer.replace(".","_")).parent("li").addClass("selected").find("span").removeClass("fa-circle-o").addClass("fa-check-circle"),$.show_layer(e),current_layer=a.layer):$this.hasClass("fa-square-o")?($("#change_map a."+a.layer.replace(".","_")).parent("li").addClass("selected").find("span").removeClass("fa-square-o").addClass("fa-check-square"),$.show_layer(e),current_layer=t):($("#change_map a."+a.layer.replace(".","_")).parent("li").removeClass("selected").find("span").removeClass("fa-check-square").addClass("fa-square-o"),$.hide_layer(a.name),$.remove_storage("pgrdg_cache.map_data.layers.current.overlay."+a.layer.replace(/\./g,"~")),current_layer=t),$.hide_all_layers(a)):$this.hasClass("fa-check-square")&&($("#change_map a."+a.layer.replace(".","_")).parent("li").removeClass("selected").find("span").removeClass("fa-check-square").addClass("fa-square-o"),$.hide_layer(a.name)),$(".leaflet-control-attribution.leaflet-control").find("a.info").html(""),$(".leaflet-control-attribution.leaflet-control").html('<div class="attribution">'+$(".leaflet-control-attribution.leaflet-control").html()+'</div><a class="info" href="javascript: void(0);" onclick="$(\'.leaflet-control-attribution.leaflet-control div.attribution\').toggle_layer_description();"><span class="fa fa-info-circle"></span></a>'),$.sub_toolbox("change_map")},$.reset_map_toolbox=function(){$("#map_sub_toolbox div").fadeOut(100),$("#map_toolbox li").removeClass("selected")},$.disable_map_toolbox=function(){$("#map_toolbox a:not(#lock_view_btn)").addClass("disabled").parent("li").addClass("disabled")},$.enable_map_toolbox=function(){$("#map_toolbox li, #map_toolbox a").removeClass("disabled")},$.fn.toggle_layer_description=function(){$(this).is(":visible")?$(this).stop().fadeOut():$(this).fadeIn(100,function(){$(this).delay(5e3).fadeOut()})},$.sub_toolbox=function(e){if("none"==$("#"+e).css("display"))$.reset_map_toolbox(),$("#"+e+"_btn").parent("li").addClass("selected"),$("#"+e).fadeIn(function(){switch($(this).addClass("open"),e){case"find_location":0===$(this).find("input").val().length?$(this).find("input").focus():$(this).find("input").select();break;case"change_map":if("none"!=$("#change_map").css("display")){var a,t=$("#change_map li");$(window).bind("keydown","down",function(e){e.preventDefault(),$.each(t,function(){$(this).removeClass("selected")}),a?(a.removeClass("selected"),next=a.nextAll('li[class!="divider"]').first(),a=next.length>0?next.addClass("selected").focus():t.eq(0).addClass("selected").focus()):a=t.eq(0).addClass("selected").focus()}).bind("keydown","up",function(e){e.preventDefault(),$.each(t,function(){$(this).removeClass("selected")}),a?(a.removeClass("selected"),next=a.prevAll('li[class!="divider"]').first(),a=next.length>0?next.addClass("selected").focus():t.last().addClass("selected").focus()):a=t.last().addClass("selected").focus()}).bind("keydown","return space insert",function(e){e.preventDefault();var t=a.find("a"),s=$.trim(t.attr("class").replace("btn change_map_btn ","").replace("_"," "));$.change_map_layer(s,t)})}break;case"user_level":break;case"tools":}});else if("close"==e)$("#map_sub_toolbox div").fadeOut(300),$("#"+e+"_btn").parent("li").removeClass("selected");else switch($("#"+e+"_btn").parent("li").removeClass("selected"),e){case"find_location":$("#"+e).fadeOut(300);break;case"change_map":$("#"+e).fadeOut(300);break;case"user_level":$("#"+e).fadeOut(300);break;case"tools":$("#"+e).fadeOut(300);break;default:$("#"+e).fadeOut(300,function(){})}},$.toggle_lock_view=function(){$.get_current_bbox();$("#pgrdg_map").hasClass("locked")?($(".leaflet-control-zoom").animate({left:"0"},300),$(".leaflet-control-attribution").animate({"margin-right":"0"},300),$("#pgrdg_map").removeClass("locked"),$("#lock_view_btn").removeClass("pulse"),$.enable_map_toolbox(),$("#selected_zone").text("Map unlocked").show().delay(5e3).hide(),$("#goto_map_btn").find("sup.lock").remove(),map.dragging.enable(),map.touchZoom.enable(),map.doubleClickZoom.enable(),map.scrollWheelZoom.enable(),map.tap&&map.tap.enable()):($(".leaflet-control-zoom").animate({left:"-50px"},300),$(".leaflet-control-attribution div.attribution").stop().fadeOut(0,function(){$(".leaflet-control-attribution").animate({"margin-right":"-120px"},300)}),$("#pgrdg_map").removeClass("grabbing"),$("#pgrdg_map").addClass("locked"),$("#lock_view_btn").addClass("pulse"),$.reset_map_toolbox(),$.disable_map_toolbox(),$("#selected_zone").html('<span style="position: fixed; top: 50%; right: 50%; margin-top: -80px; opacity: 0.5; text-shadow: 0px 0px 100px rgb(0, 0, 0);" class="fa fa-lock fa-2x"></span>'+i18n[lang].interface.map_locked).stop().show(),$("#goto_map_btn").append('<sup class="lock"> <span class="fa fa-lock text-danger"></span></sup>'),map.dragging.disable(),map.touchZoom.disable(),map.doubleClickZoom.disable(),map.scrollWheelZoom.disable(),map.tap&&map.tap.disable())},$.show_guides=function(){$("#guides").show(),$(document).on("mousemove",function(e){$("#guides").find("#gx").css({top:e.pageY,left:0,width:e.pageX-5}),$("#guides").find("#gxx").css({top:e.pageY,left:e.pageX+5,width:$(document).width()-e.pageX}),$("#guides").find("#gy").css({left:e.pageX,top:0,height:e.pageY-5}),$("#guides").find("#gyy").css({left:e.pageX,top:e.pageY+5,height:$(document).height()-e.pageY})})},$.hide_guides=function(){$("#guides").hide()},$.sh_menu=function(){$("#nav").is(":visible")?($("#nav").hide("slide",{direction:"right"},100),$("#show_hide_menu_btn").closest("li").removeClass("selected")):($("#nav").show("slide",{direction:"right"},100),$("#show_hide_menu_btn").closest("li").addClass("selected"))},$.sh_breadcrumb=function(){$("#breadcrumb").is(":visible")?($("#breadcrumb").hide("slide",{direction:"right"},100),$("#show_hide_breadcrumb_btn").closest("li").removeClass("selected")):($("#show_hide_breadcrumb_btn span.fa").addClass("fa-1rspin"),$("#breadcrumb").show("slide",{direction:"right"},100,function(){$("#show_hide_breadcrumb_btn span.fa").removeClass("fa-1rspin")}),$("#show_hide_breadcrumb_btn").closest("li").addClass("selected"))},$.contextMenu=function(){$("#knob").hide(),$("#pgrdg_map").removeClass("grabbing");var e=$("#knob");$("body").on("contextmenu","#pgrdg_map:not(.locked), #knob:not(header)",function(a){a.preventDefault(),0===$("#clicked_coords").length&&$("body").prepend('<span style="display: none;" id="clicked_coords"></span>');var t=map.getCoordinateFromPixel([a.clientX,a.clientY]),s=ol.proj.transform(t,"EPSG:3857","EPSG:4326");return $("#clicked_coords").text('{"lon": '+s[0]+',"lat": '+s[1]+"}"),e.css({left:a.pageX-100,top:a.pageY-200}).fadeIn(300),!1}),e.on("click","a",function(){e.hide()}),$("#knob, #pgrdg_map, #pgrdg_map > *").click(function(){e.hide()})},$.find_location=function(e){e=$.extend({"accept-language":lang,format:"json",lat:0,lon:0,addressdetails:0,zoom:18},e);var a={format:e.format,"accept-language":e["accept-language"],lat:e.lat,lon:e.lon,zoom:e.zoom,addressdetails:e.addressdetails};$.ajax({url:"API/",type:"get",format:"json",crossDomain:!0,data:{proxy:"true",type:"get",header:"text/json",address:"http://nominatim.openstreetmap.org/reverse?"+$.param(a)},error:function(a){e.error(a)},success:function(a){e.success(a)}})},$.fn.search_location=function(e){$.show_results=function(a,t){var s="";$("#information_zone").html("<h3>"+i18n[lang].messages.search.results_for.replace("{X}",e)+'</h3><ul class="fa-ul"></ul>'),$.each(a,function(a,t){var s,r=i18n[lang].messages.search.search_of.replace("{X}",'"'+e+'"'),o=t.display_name;s=0===a?"primary":"secondary",void 0!==t.geojson&&$.obj_len(t.geojson)>0?$.add_geojson_cluster({id:t.place_id,geojson:t.geojson,lon:t.lon,lat:t.lat,service:!1,name:t.display_name,title:r,content:o,center:!1}):$.add_marker({uuid:t.place_id,lon:t.lon,lat:t.lat,marker_class:s,name:t.display_name,title:r,content:o}),$("#information_zone ul").append('<li><a class="btn '+(0===a?"disabled":"")+'" href="javascript: void(0);" onclick="$(this).select_marker({marker_id: \''+t.place_id+"', title: '"+r.replace(/"/g,"&quot;")+"', content: '"+o.replace(/"/g,"&quot;")+'\'});" title="'+t.display_name+'"><span class="fa fa-fw fa-angle-right"></span>'+t.display_name+"</a></li>"),markerMap[t.place_id]=t}),$("#map_toolbox span.ion-loading-c").removeClass("ion-loading-c").addClass("ion-search").parent("a").removeClass("disabled"),$("#find_location input").prop("disabled",!1),map.fitBounds([[parseFloat(a[0].boundingbox[0]),parseFloat(a[0].boundingbox[2])],[parseFloat(a[0].boundingbox[1]),parseFloat(a[0].boundingbox[3])]]),$("#"+a[0].place_id).popover("show"),map.invalidateSize(),"function"==typeof t&&t.call(this,s)},$("#loader").show(),user_search_layers.clearLayers(),map.closePopup(),$(this).find("span").length>0&&$(this).find("span").hasClass("fa-check-circle")?($("#information_zone").html(""),$("#selected_zone").stop().hide(),$(this).find("span").removeClass("fa-check-circle").addClass("fa-circle-o"),$("#loader").hide()):($.each($(this).closest("ul").find("li"),function(){$(this).find("a.pull-left span").length>0&&$(this).find("a.pull-left span").hasClass("fa-check-circle")&&$(this).find("a.pull-left span").removeClass("fa-check-circle").addClass("fa-circle-o")}),$(this).find("span").length>0&&$(this).find("span").hasClass("fa-circle-o")&&$(this).find("span").removeClass("fa-circle-o").addClass("fa-check-circle"),e.length>0&&($("#map_toolbox #find_location_btn span").removeClass("ion-search").addClass("ion-loading-c").parent("a").addClass("disabled"),$("#find_location input").attr("disabled",!0),$("#information_zone").html(""),$("#selected_zone").html(i18n[lang].messages.search.map_search_place.replace("{X}",e)).fadeIn(300).delay(5e3).fadeOut(600),$.storage_exists("pgrdg_cache.map_data.user_layers.searches."+$.md5(e))?$.show_results(storage.get("pgrdg_cache.map_data.user_layers.searches."+$.md5(e)+".results"),function(){$("#selected_zone").stop().hide(),$("#loader").hide()}):$.ajax({url:"API/",type:"get",format:"json",crossDomain:!0,data:{proxy:"true",type:"get",header:"text/json",address:"http://nominatim.openstreetmap.org/search.php?q="+encodeURIComponent(e)+"&format=json&addressdetails=true&bounded=true&limit=10&polygon_geojson=true"},success:function(a){var t=$.parseJSON(a);$.obj_len(t)>0?(storage.set("pgrdg_cache.map_data.user_layers.searches."+$.md5(e),{input:e,results:t}),$("#selected_zone").text(t[0].display_name).fadeIn(300).delay(5e3).fadeOut(600).stop(),$.show_results(t,function(){$("#selected_zone").stop().hide(),$("#loader").hide()}),$.get_generated_layers($.md5(e))):($("#selected_zone").text(i18n[lang].messages.search.no_search_results.message).delay(5e3).fadeOut(600).stop(),$("#map_toolbox span.ion-loading-c").removeClass("ion-loading-c").addClass("ion-search").parent("a").removeClass("disabled"),$("#find_location input").prop("disabled",!1))},error:function(){$("#selected_zone").text(i18n[lang].messages.search.no_search_results.message).delay(5e3).fadeOut(600),$("#map_toolbox span.ion-loading-c").removeClass("ion-loading-c").addClass("ion-search").parent("a").removeClass("disabled"),$("#find_location input").prop("disabled",!1)}})))},$.remove_selected_search=function(e,a,t){$.exec_removal=function(){$("li#"+e).find("span:first-child").hasClass("fa-check-circle")&&(user_search_layers.clearLayers(),map.closePopup()),$("li#"+e).find("span:first-child").hasClass("fa-check-square")&&(user_layers.clearLayers(),map.closePopup(),$.each($("li#"+e).closest("ul").find("li"),function(){$(this).find("a.pull-left span").hasClass("fa fa-check-square")&&$(this).attr("id")!==e&&$.storage_exists("pgrdg_cache.map_data.user_layers.results."+$(this).attr("id"))&&$.add_geojson_cluster({id:$(this).attr("id"),geojson:storage.get("pgrdg_cache.map_data.user_layers.results."+$(this).attr("id")+".results"),title:"OK",content:"Yeah"})})),$("li#"+e).remove(),$("#information_zone").fadeOut(300,function(){$(this).html("")}),$.remove_storage("pgrdg_cache."+a+"."+e,function(){0===$.obj_len(storage.get("pgrdg_cache."+a))&&$.remove_storage({check:!1,name:"pgrdg_cache."+a},function(){$("#user_layers").hide(),0===$.obj_len(storage.get("pgrdg_cache.map_data.user_layers"))&&$("#user_level_btn").hide()})})};void 0===t&&(t=!1),t?apprise(i18n[lang].messages.map.are_you_sure_to_remove_this_layer.message,{title:i18n[lang].messages.map.are_you_sure_to_remove_this_layer.title,icon:"warning",confirm:!0},function(e){e&&$.exec_removal()}):$.exec_removal()},$.fn.select_marker=function(e){e=$.extend({marker_id:"",title:"",content:""},e),$.each($(this).closest("ul").find("li a"),function(){$(this).removeClass("disabled")}),$(this).addClass("disabled");{var a=markerMap[e.marker_id];L.popup().setLatLng(L.latLng(a.lat+10,a.lon)).setContent('<h4 class="text-info"><span class="fa-map-marker text-danger fa fa-lg"></span> '+e.title+"</h4><p>"+e.content+"</p>")}$("#selected_zone").html(e.content).show().stop().delay(5e3).hide(),map.closePopup(),"Point"==map.geojson.type?($.set_center(a.lon,a.lat,10),map.invalidateSize()):(map.fitBounds([[parseFloat(a.boundingbox[0]),parseFloat(a.boundingbox[2])],[parseFloat(a.boundingbox[1]),parseFloat(a.boundingbox[3])]]),map.invalidateSize())},$.fn.toggle_layer_btn=function(e){$(this).find("span").hasClass("fa-square-o")?($(this).find("span").removeClass("fa-square-o").addClass("fa-check-square"),$("#loader").removeClass("system").fadeIn(100,function(){map.addLayer(user_layers),$.storage_exists("pgrdg_cache.map_data.user_layers.results."+e)&&$.add_geojson_cluster({id:e,geojson:storage.get("pgrdg_cache.map_data.user_layers.results."+e+".results"),title:"OK",content:"Yeah"},function(){$("#loader").fadeOut(150)})})):($(this).find("span").removeClass("fa-check-square").addClass("fa-square-o"),user_layers.clearLayers(),map.closePopup(),$.each($(this).closest("ul").find("li"),function(){$(this).find("a.pull-left span").hasClass("fa fa-check-square")&&$.storage_exists("pgrdg_cache.map_data.user_layers.results."+$(this).attr("id"))&&$.add_geojson_cluster({id:e,geojson:storage.get("pgrdg_cache.map_data.user_layers.results."+$(this).attr("id")+".results"),title:"OK",content:"Yeah"})}))},$.add_heatmap=function(e,a){e=$.extend({radius:20,blur:15,maxZoom:17}),void 0===a&&(a=[[-37.8210922667,175.2209316333,"2"],[-37.8210819833,175.2213903167,"3"],[-37.8210881833,175.2215004833,"3A"],[-37.8211946833,175.2213655333,"1"],[-37.8209458667,175.2214051333,"5"],[-37.8208292333,175.2214374833,"7"],[-37.8325816,175.2238798667,"537"],[-37.8315855167,175.2279767,"454"],[-37.8096336833,175.2223743833,"176"],[-37.80970685,175.2221815833,"178"],[-37.8102146667,175.2211562833,"190"],[-37.8088037167,175.2242227,"156"],[-37.8112330167,175.2193425667,"210"],[-37.8116368667,175.2193005167,"212"],[-37.80812645,175.2255449333,"146"],[-37.8080231333,175.2286383167,"125"],[-37.8089538667,175.2222222333,"174"],[-37.8080905833,175.2275400667,"129"],[-37.8194342167,175.22322975,"9"]]);
var t=L.heatLayer(a,e);map.addLayer(t),console.log("Heatmap added. Visible?")},$.add_marker=function(e){e=$.extend({lon:0,lat:0,uuid:$.uuid(),type:"marker",name:"",title:"",cloud:!0,size:"1.5em",marker_class:"primary",content:"Sample text",dynamic_content:"",buttons:!0},e),$("#"+e.uuid).length>0&&$("#"+e.uuid).remove();var a=L.circle([e.lat,e.lon],3e3,{color:"red",fillColor:"#f03",fillOpacity:.5}).addTo(map);a.bindPopup("<h4>"+e.title+"</h4>"+("function"==typeof e.content?e.content():e.content)).openPopup()},$.reset_all_markers=function(e,a){void 0===e||void 0===a?$("#pgrdg_map .leaflet-marker-pane").html(""):e.removeLayer(a)},$.add_point=function(e){e=$.extend({lon:0,lat:0,uuid:$.uuid(),name:"",title:"",marker_class:"primary",content:"Sample text",callback:function(){}},e),"function"==typeof callback&&callback.call(this),$("#"+e.uuid).length>0&&$("#"+e.uuid).remove();var a=('<a class="btn btn-default btn-sm" title="Center point on the screen" href="javascript:void(0);" onclick="$.set_center(\''+e.lon+"','"+e.lat+'\');"><span class="fa fa-crosshairs"></span></a>','<a class="btn btn-default btn-sm" title="Zoom here" href="javascript:void(0);" onclick="$.set_center(\''+e.lon+"','"+e.lat+"'); $.set_zoom(12); $('#"+e.uuid+"').popover('hide');\"><span class=\"fa fa-search-plus\"></span></a>",'<a class="btn btn-default btn-sm right" title="Remove this point" href="javascript:void(0);" onclick="$(\'#'+e.uuid+"').popover('hide'); $('#"+e.uuid+'\').remove();"><span class="fa fa-trash-o"></span></a>',new ol.Overlay({position:$.set_lonlat(e.lon,e.lat),positioning:"center-center",element:$('<div class="marker '+e.marker_class+'" id="'+e.uuid+'"></div>').css({cursor:"pointer"}).bind("click",function(){console.log(e.lon,e.lat)}),stopEvent:!1}));map.addOverlay(a)},$.add_geojson_cluster=function(e,a){e=$.extend({geojson:"",id:"",service:!0,name:"",title:"",content:"",center:!0},e);var t=L.markerClusterGroup(),s=L.geoJson(e.geojson);if(e.service?(t.addLayer(s),user_layers.addLayer(t)):(t.addLayer(s),user_search_layers.addLayer(t)),e.center){var r=(t.getBounds().getCenter(),{});r.southwest=[t.getBounds().getSouthWest().lat,t.getBounds().getSouthWest().lng],r.northeast=[t.getBounds().getNorthEast().lat,t.getBounds().getNorthEast().lng],map.fitBounds([r.southwest,r.northeast]),"function"==typeof a&&a.call(this)}t.on("click",function(a){var t=0,s=($("#marker_content").find(".modal-header"),$("#marker_content").find(".modal-body"));if(e.service)s.html('<center class="text-muted"><span class="fa fa-refresh fa-spin"></span> Extracting data</center>'),$("#marker_content").modal("show").on("shown.bs.modal",function(){if(0===t){var e={};e.storage_group="pgrdg_cache.results",e[kAPI_REQUEST_OPERATION]=kAPI_OP_GET_UNIT,e.parameters={},e.parameters[kAPI_REQUEST_LANGUAGE]=lang,e.parameters[kAPI_REQUEST_PARAMETERS]={},e.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_LOG_REQUEST]=!0,e.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_ID]=a.layer.feature.properties.id,e.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_DATA]=kAPI_RESULT_ENUM_DATA_FORMAT,e.parameters[kAPI_REQUEST_PARAMETERS][kAPI_PARAM_DOMAIN]=a.layer.feature.properties.domain,$.ask_to_service(e,function(e){$("#marker_content .modal-title").html('<span class="fa-map-marker text-danger fa fa-lg"></span> <span class="text-primary">'+a.layer.feature.properties.id+"</span>"),$.each(e.results,function(e,a){$("#marker_content").find(".modal-body").html($.parse_row_content(a))})}),$("#marker_content a.text-info").popover({container:"body",placement:"auto",html:"true",trigger:"hover"})}t++});else{L.popup().setLatLng(L.latLng(e.lat,e.lon)).setContent('<h4 class="text-info"><span class="fa-map-marker text-danger fa fa-lg"></span> '+e.title+"</h4><p>"+e.content+"</p>").openOn(map)}})},$.add_popup=function(e,a){e=$.extend({div:"Popup",lon:0,lat:0,uuid:$.uuid(),size:{width:200,height:200},name:"",title:"Selected location",html:"Sample text",callback:function(){}},e),"function"==typeof a&&a.call(this);var t='<a class="btn btn-default btn-sm" title="Center point on the screen" href="javascript:void(0);" onclick="$.set_center(\''+e.lon+"','"+e.lat+'\');"><span class="fa fa-crosshairs"></span></a>',s='<a class="btn btn-default btn-sm" title="Zoom here" href="javascript:void(0);" onclick="$.set_center(\''+e.lon+"','"+e.lat+"'); $.set_zoom(12);$('#"+e.uuid+"').popover('hide');\"><span class=\"fa fa-search-plus\"></span></a>",r='<a class="btn btn-default btn-sm" title="Move this point" href="javascript:void(0);" onclick="$.move_point(\''+e.uuid+"'); $('#"+e.uuid+"').popover('hide');\"><span class=\"fa fa-arrows\"></span></a>",o='<a class="btn btn-default btn-sm right" title="Remove this point" href="javascript:void(0);" onclick="$(\'#'+e.uuid+"').popover('hide');\"><span class=\"fa fa-trash-o\"></span></a>",n='<a class="btn btn-default btn-sm right" title="Calculate distance" href="javascript:void(0);" onclick="$.gui_measure_distances(\'point\', {lon: \''+e.lon+"', lat:'"+e.lat+", title:'"+e.name+'\'})"><span class="ion-fork-repo"></span></a>',l=new ol.Overlay({position:$.set_lonlat(e.lon,e.lat),positioning:"center-center",element:$('<div class="marker draggable '+(void 0!==e.marker_class?e.marker_class:"")+'" id="'+e.uuid+'"></div>').css({cursor:"pointer"}).popover({html:!0,title:e.title+'<a href="javascript:void(0);" onclick="$(\'#'+e.uuid+"').popover('hide');\" class=\"close\">&times;</a>",content:'<div class="content">'+e.content+"<br /><br /><code>"+ol.coordinate.toStringHDMS([e.lon,e.lat])+'</code></div><br /><br /><div class="popup_btns row"><div class="col-sm-12 btn-toolbar"><div class="btn-group">'+t+s+'</div><div class="btn-group right">'+r+o+n+"</div></div></div>",placement:"top",trigger:"click"}),stopEvent:!1});map.addOverlay(l),$("#"+e.uuid).popover("show")},$.get_click_info=function(){var e=$.parseJSON($("#clicked_coords").text());$.find_location({lon:e.lon,lat:e.lat,addressdetails:1,error:function(){alert("An error occurred while communicating with the OpenLS service. Please try again.")},success:function(a){datap=$.parseJSON(a),$.add_popup({lon:e.lon,lat:e.lat,title:"Location info",content:datap.display_name})}})},$.show_help=function(){$("header").hasClass("map")&&($.reset_map_toolbox(),$("#map_toolbox_help").modal("show")),$.add_heatmap()},$(document).ready(function(){"Map"==current_path?($("header.main, section.container, #left_panel").addClass("map"),$("#logo img").attr("src","common/media/svg/bioversity-logo_small_white.svg"),$("#pgrdg_map, .panel_content").fadeIn(600),$("#map_toolbox").delay(600).animate({right:"0"},300),$("#breadcrumb .breadcrumb li.pull-right").hide(),map=$.init_map(function(){$.get_generated_layers("storage")})):$("#breadcrumb .breadcrumb li.pull-right").show()});